<html>
<head>
<style>
* {
    image-rendering: pixelated;
}
canvas {
    image-rendering: pixelated;
}
.colorField {
    width:7vmin;
    height:4vmin;
    outline:4px solid red;
    background-color: #FFFFFF;
}
#colorDiv {
    display:flex;
    flex-wrap:wrap;
    max-width:94%;
    gap:20px;
}
#colorSlider {
    width:min(512px,90vmin);
}
.robeSelect1 {
    display:none;
    background-color: #000000;
    color:#80FF80;
}
.robeSelect1:focus {
    border-radius: 2px;
    outline: 1px solid #80FF80;
}
#robeDisplay {
    display:none;
    grid-template-columns: repeat(auto-fit,minmax(max(103px,40vmin),1fr));
    padding:16px;
    text-align:center;
    gap:8px;
}
.robeChild {
    padding:16px;
    width:minmax(102px,40vmin);
    max-width:512px;
    height:minmax(102px,40vmin);
    border-radius:15px;
    transition:background-color 0.2s,outline 0.2s;
}
.robeChild:hover {
    background-color:#303030;
    outline:2px solid aqua;
}
</style>
<title>Robes</title>
</head>
<body bgColor="#404040" text="#80FF80" onmousemove="updateEyeTool(event)" onkeydown="keyDown(event)">
<canvas id="test" width=512 height=512 onclick="testFunction(event);" style="outline:2px solid #808080"></canvas><br>
<input type="button" value="undo" onclick="undo()"><input type="button" value="redo" onclick="redo()" style="position:relative;left:15vmin;"><input type="button" value="Eyedrop tool" onclick="activateEyeDrop();" style="position:relative;left:30vmin;"><input type="checkbox" id="lineBox" onchange="updateLines()" style="position:relative;left:50vmin;"><label for="lineBox" style="position:relative;left:50vmin;">Helplines</label>
<br><input type="color" id="inColor" onchange="testToHex();"><br><input type="text" value="#00000000" id="hexColor" onchange="testHex();"><br>
<label for="colorSlider">Alpha: <input type="range" min="0" max="255" step="1" value="0" id="colorSlider" onchange="alphaUpdate()"></label><br><br>
<input type="button" value="Currently in replace color mode" onclick="btnChange()" id="scratch"><br><br>
<div id = "colorDiv"><div class="colorField" onclick="colorPick(0)"></div><div class="colorField" onclick="colorPick(1)"></div><div class="colorField" onclick="colorPick(2)"></div><div class="colorField" onclick="colorPick(3)"></div><div class="colorField" onclick="colorPick(4)"></div><div class="colorField" onclick="colorPick(5)"></div><div class="colorField" onclick="colorPick(6)"></div><div class="colorField" onclick="colorPick(7)"></div><div class="colorField" onclick="colorPick(8)"></div><div class="colorField" onclick="colorPick(9)"></div><div class="colorField" onclick="colorPick(10)"></div><div class="colorField" onclick="colorPick(11)"></div></div><br>
<label for="testInputFile">Import color strip: <input type = "file" id="testInputFile" onchange="testFile();"></label><input type="button" value="Save color strip" onclick="savestrip()"><br><br>
<select id="robeSelect" onchange="robeSel()">
<option value="None">--Stored Robes--</option>
</select>
<input type="text" class="robeSelect1" onchange="robeSel()"><br><br>
<input type="button" value="Save Robe" onclick="addRobe(true)"><input type="button" value="Delete robe" style="position: relative;left:10vmin;" onclick="deleteRobe(true)"><input type="button" value="Replace robe" style="position: relative;left:20vmin;" onclick="replaceRobe(true)"><br><br>
<form>
<label for="displayName">Name of robe: </label>
<input type="text" id="displayName" onchange="updateText()"><span id="displayNameig"></span>
<br><br><label for="description">Description of robe: </label>
<input type="text" id="description" onchange="updateText()"><span id="descriptionig"></span>
<br><br><label for="designer">Designer of robe: </label>
<input type="text" id="designer"><br>
<input type="button" value="Download Robe" onClick="toRobeFile()">
<input type="button" style="position:relative;left:15vmin;top:2px;" value="Upload Robe" onClick="upload()"><br><br>
<input type="button" style="position:relative;top:2px;" value="Show Locally Stored Robes" onClick="showRobes(0)">
<input type="button" style="position:relative;top:2px;" value="Show Globally Stored Robes" onClick="showRobes(1)">
<select id="pageSelect" style="position:relative;top:2px;" onchange="selPage()">
    <option value="None">Page</option>
</select>
<select id="sortOrder" style="position:relative;top:2px;" onchange="sortCh()">
    <option value="0">Newest first</option>
    <option value="1">Oldest first</option>
</select>
</form>
<img id="testImage" style="display:none;"></img><canvas style="display:none;" id="imageBuffer"></canvas>
<canvas id="eyeDrop" style="display:none;" onclick="eyeTrigger(event);"></canvas>
<div id="robeDisplay"></div>
<script>
let order = true;
function sortCh() {
    let lop = parseInt(document.getElementById("sortOrder").value);
    order=lop==0;
    showRobes(curMode);
}
let prevMode = -1;
let curMode = 0;
let hasChanged = false;
let devtools = false;
function toBlob(str) {
    if (!devtools) return;
    let blob = new Blob([str]);
    let a = document.createElement("a");
    a.download="Strip.txt";
    a.href=URL.createObjectURL(blob);
    a.click();
    URL.revokeObjectURL(a.href);
}
function removeDuplicates() {
    let dups = [];
    for (let i = 0; i < robeStorage.length; i++) {
        if (dups.includes(i)) continue;
        for (let l = i+1; l < robeStorage.length; l++) {
            if (dups.includes(l)) continue;
            let same = true;
            for (let o = 0; o < robeStorage[i].length; o++) {
                if (robeStorage[i][o]==robeStorage[l][o]) continue;
                same = false;
                break;
            }
            if (!same) continue;
            dups.push(l);
        }
    }
    let tmpStor = [];
    for (let i = 0; i < robeStorage.length; i++) {
        if (dups.includes(i)) continue;
        let tmpBuf = [];
        for (let l = 0; l < robeStorage[i].length; l++) {
            tmpBuf.push(robeStorage[i][l]);
        }
        tmpStor.push(tmpBuf);
    }
    robeStorage=tmpStor;
}
function checkValid(arr) {
    for (let i = 0; i < arr.length; i++) {
        if (arr.charCodeAt(i)==0xa || arr.charCodeAt(i)==0xd) return false;
        if (arr.charCodeAt(i)<0x80) continue;
        return false;
    }
    return true;
}

function findDifferences(a,b) {
    let outPut = "";
    let c = 0;
    for (;c < Math.min(a.length,b.length); c++) {
        if (a[c]==b[c]) {
            outPut+=a[c]+"=="+b[c]+"\n";
            continue;
        }
        outPut+=a[c]+"!="+b[c]+"\n";
    }
    if (a.length!=b.length) {
        if (a.length>b.length) {
            for (;c<a.length; c++) {
                outPut+=a[c]+"=None\n";
            }
        } else {
            for (;c<b.length; c++) {
                outPut+="---"+b[c]+"\n";
            }
        }
    }
    console.log(outPut);
}
function hexToStr(str) {
    let out = "";
    for (let i = 0; i < str.length; i++) {
        let a = str.charCodeAt(i++);
        let res = 0;
        if (a>0x39) a=(a&0xDF)-7;
        a-=0x30;
        res+=a;
        res=res<<4;
        a = str.charCodeAt(i);
        if (a>0x39) a=(a&0xDF)-7;
        a-=0x30;
        res+=a;
        out+=String.fromCharCode(res);
    }
    return out;
}
function strToHex(str) {
    let out = "";
    for (let i = 0; i < str.length; i++) {
        let a = str.charCodeAt(i).toString(16);
        while (a.length<2) {
            a="0"+a;
        }
        out+=a;
    }
    return out;
}
function toMin(arr) {
    let listA = [];
    let listD = [];
    let prepend = "";
    let filtered = "";
    for (let i = 0; i < arr.length; i++) {
        if (arr.charCodeAt(i)==0xa) {
            let tmp = i+1;
            if (tmp>=0xa) tmp++;
            if (tmp>=0x4FF) tmp+=0x80;
            if (tmp>=0x27FFF) tmp+=0x4000;
            if (tmp>=0xd) tmp++;
            if (tmp>=0x67F) tmp+=0x80;
            if (tmp>=0x33FFF) tmp+=0x4000;
            listA.push(tmp);
            continue;
        }
        if (arr.charCodeAt(i)==0xd) {
            let tmp = i+1;
            if (tmp>=0xa) tmp++;
            if (tmp>=0x4FF) tmp+=0x80;
            if (tmp>=0x27FFF) tmp+=0x4000;
            if (tmp>=0xd) tmp++;
            if (tmp>=0x67F) tmp+=0x80;
            if (tmp>=0x33FFF) tmp+=0x4000;
            listD.push(tmp);
            continue;
        }
        filtered+=arr[i];
    }
    console.log(listA,listD);
    for (let i = 0; i < listA.length; i++) {
        prepend+=String.fromCharCode(listA[i]>>14&0x7F);
        prepend+=String.fromCharCode(listA[i]>>7&0x7F);
        prepend+=String.fromCharCode(listA[i]&0x7F);
    }
    prepend+="\x00\x00\x00";
    for (let i = 0; i < listD.length; i++) {
        prepend+=String.fromCharCode(listD[i]>>14&0x7F);
        prepend+=String.fromCharCode(listD[i]>>7&0x7F);
        prepend+=String.fromCharCode(listD[i]&0x7F);
    }
    prepend+="\x00\x00\x00";
    return prepend+filtered;
}
function toMax(arr) {
    let listA = [];
    let listD = [];
    let combined = "";
    let count = 0;
    let newCount = 0;
    while (count<arr.length) {
        let l = arr.charCodeAt(count++);
        l=l<<7;
        l += arr.charCodeAt(count++);
        l=l<<7;
        l += arr.charCodeAt(count++);
        if (l>=0xa) l--;
        if (l>=0x4FF) l-=0x80;
        if (l>=0x27FFF) l-=0x4000;
        if (l>=0xd) l--;
        if (l>=0x67F) l-=0x80;
        if (l>=0x33FFF) l-=0x4000;
        if (l==0) break;
        listA.push(l-1);
    }
    while (count<arr.length) {
        let l = arr.charCodeAt(count++);
        l=l<<7;
        l += arr.charCodeAt(count++);
        l=l<<7;
        l += arr.charCodeAt(count++);
        if (l>=0xa) l--;
        if (l>=0x4FF) l-=0x80;
        if (l>=0x27FFF) l-=0x4000;
        if (l>=0xd) l--;
        if (l>=0x67F) l-=0x80;
        if (l>=0x33FFF) l-=0x4000;
        if (l==0) break;
        listD.push(l-1);
    }
    console.log(listA,listD);
    while (count<arr.length) {
        while (listA.includes(newCount) || listD.includes(newCount)) {
            if (listA.includes(newCount)) {
                combined+="\x0a";
            } else {
                combined+="\x0d";
            }
            newCount++;
        }
        combined+=arr[count++];
        newCount++;
    }
    while (listA.includes(newCount) || listD.includes(newCount)) {
        if (listA.includes(newCount)) {
            combined+="\x0a";
        } else {
            combined+="\x0d";
        }
        newCount++;
    }
    return combined;
}
function join(arr) {
    let list = "";
    let count = 0;
    let bitOffset = 0;
    function readByte() {
        let res = 0;
        for (let i = 0; i < 8; i++) {
            if (count>=arr.length) {
                res=0x100;
                break;
            }
            res=res<<1;
            res+=(arr.charCodeAt(count)>>(6-bitOffset++))&1;
            if (bitOffset>=7) {
                bitOffset = 0;
                count++;
            }
        }
        return res;
    }
    for (let i = 0; i < arr.length; i++) {
        if (count>=arr.length) break;
        let tmp = readByte();
        if (tmp>0xFF) break;
        //if (count>=arr.length) break;
        list+=String.fromCharCode(tmp);
    }
    return list;
}
function split(arr) {
    let list = "";
    let bitOffset = 0;
    let bitCount = 1;
    let carry = 0;
    let hasCarry = false;
    function writeByte(x) {
        let tmp = ((x>>bitCount)&((1<<(8-bitCount))-1))+carry;
        list+=String.fromCharCode(tmp);
        carry = (x&((1<<bitCount)-1))<<(7-bitCount);
        bitCount++;
        hasCarry = true;
        if (bitCount>=8) {
            bitCount=1;
            list+=String.fromCharCode(carry);
            carry=0;
            hasCarry = false;
        }
    }
    for (let i = 0; i < arr.length; i++) {
        writeByte(arr.charCodeAt(i));
    }
    if (hasCarry) list+=String.fromCharCode(carry);
    return list;
}
var lastupload = null;
var lastdata = null;
function upload(override,process=true) {
    if (override==null && !hasChanged) return;
    if (!confirm("Are you sure you want to upload this robe?")) return;
    hasChanged=false;
    addRobe();
    let formData = new FormData();
    let data = rIDtoStr(robeStorage.length-1)
    removeDuplicates();
    storeRobes();
    loadRobes();;
    if (override!=null) data=override;
    let old = data;
    toBlob(data);
    let encoder = new TextEncoder();
    let decoder = new TextDecoder();
    //data=btoa(data);
    if (process) data=toMin(split(data));
    lastdata = data;
    //console.log(data);
    /*
    let filtered = "";
    let listA = [];
    let listD = [];
    for (let i = 0; i < data.length; i++) {
        if (data.charCodeAt(i)==0xa) {
            listA.push(numToActual(i));
            continue;
        }
        if (data.charCodeAt(i)==0xd) {
            listD.push(numToActual(i));
            continue;
        }
        filtered+=data[i];
    }
    console.log(listA);
    console.log(listD);
    let prepend = "";
    for (let i = 0; i < listA.length; i++) {
        prepend+=String.fromCharCode(listA[i]>>14&0x7F);
        prepend+=String.fromCharCode(listA[i]>>7&0x7F);
        prepend+=String.fromCharCode(listA[i]&0x7F);
    }
    prepend+="\x00\x00\x00";
    for (let i = 0; i < listD.length; i++) {
        prepend+=String.fromCharCode(listD[i]>>14&0x7F);
        prepend+=String.fromCharCode(listD[i]>>7&0x7F);
        prepend+=String.fromCharCode(listD[i]&0x7F);
    }
    console.log(listA,listD);
    prepend+="\x00\x00\x00";
    data=prepend+filtered;
    let listA1 = [];
    let listD1 = [];
    let li = 0;
    let count = 0;
    while (li<data.length) {
        count = data.charCodeAt(li++);
        count=count<<7;
        count+=data.charCodeAt(li++);
        count=count<<7;
        count+=data.charCodeAt(li++);
        if (count>=0xa0000) count-=0x10000;
        if (count>=0xa00) count-=0x100;
        if (count>=0xa) count--;
        if (count==0) break;
        listA1.push(count);
    }
    console.log(li);
    while (li<data.length) {
        count = data.charCodeAt(li++);
        count=count<<7;
        count+=data.charCodeAt(li++);
        count=count<<7;
        count+=data.charCodeAt(li++);
        if (count>=0xa0000) count-=0x10000;
        if (count>=0xa00) count-=0x100;
        if (count>=0xa) count--;
        if (count==0) break;
        listD1.push(count);
    }
    console.log(li);
    console.log(listA1,listD1);
    let outList = [];
    for (;li<data.length;li++) {
        while (listA.includes(outList.length) || listD.includes(outList.length)) {
            if (listA.includes(outList.length)) {
                outList.push("\x0a");
            } else {
                outList.push("\x0d");
            }
        }
        outList.push(data[li]);
    }
    let finalOut = [];
    outList=outList.join("");
    count = 0;
    let bitOffset = 0;
    for (let i = 0; i < outList.length; i++) {
        if (count>=outList.length) break;
        let res = 0;
        for (let i = 0; i < 8; i++) {
            if (count>=outList.length) break;
            res=res<<1;
            res+=(outList.charCodeAt(count)>>(6-bitOffset++))&1;
            if (bitOffset>=7) {
                bitOffset = 0;
                count++;
            }
        }
        if (count>=outList.length) break;
        finalOut.push(res);//String.fromCharCode(res));
    }
    /*
    for (let i = 0; i < outList.length; i++) {
        outList[i]=String.fromCharCode(outList[i]);
    }
    */
    //finalOut = join(outList.join(""));
    //console.log(old.length,finalOut.length);
    /*let tmp = [];
    for (let i = 0; i < old.length; i++) {
        tmp.push(old.charCodeAt(i));
    }*/
    //console.log(old);//tmp.join(","));
    //console.log(finalOut);//.join(","));
    //return;
    formData.append("Data",data);//prepend+filtered);
    //toBlob(prepend+filtered);
    let xhr = new XMLHttpRequest();
    xhr.open("POST","test.php");
    xhr.onload=function(event) {
        console.log(event);
        console.log(xhr.response);
        lastupload=xhr.response;
        if (xhr.response!="Success") {
            alert("Something went wrong...");
        } else {
            alert("Uploaded!");
        }
    }
    xhr.send(formData);
}
let bufferCanvas = document.getElementById("imageBuffer");
let robeDisplay = document.getElementById("robeDisplay");
let storage = null;
function toArr(id) {
    let out = [];
    for (let i = 0; i < robeStorage.length; i++) {
        if (i!=id) continue;
        let palStr = robeStorage[i][3];
        let o = 0n;
        for (let i = 0; i < palStr.length; i++) {
            o=(o<<8n)+BigInt(palStr.charCodeAt(i));
            if (i>0 && (1+i)%4==0) {
                out.push(Number.parseInt(o));
                o=0n;
            }
        }
        break;
    }
    return out;
}
function toGArr(id) {
    let out = [];
    for (let i = 0; i < storage.length; i++) {
        if (i!=id) continue;
        let palStr = storage[i][3];
        let o = 0n;
        for (let i = 0; i < palStr.length; i++) {
            o=(o<<8n)+BigInt(palStr.charCodeAt(i));
            if (i>0 && (1+i)%4==0) {
                out.push(Number.parseInt(o));
                o=0n;
            }
        }
        break;
    }
    return out;
}
let urlList = [];
function clearUrls() {
    for (let i = 0; i < urlList.length; i++) {
        URL.revokeObjectURL(urlList[i]);
    }
    urlList=[];
}
let working = false;
let page = 1;
function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}
function selPage() {
    let pageSelect = document.getElementById("pageSelect");
    if (pageSelect.value=="None") return;
    page=parseInt(pageSelect.value);
    showRobes(curMode);
}
async function showRobes(mode) {
    if (working && mode!=0) return;
    let pageSelect = document.getElementById("pageSelect");
    if (prevMode!=mode) {
        page = 1;
        let text = "<option value=\"None\"> Page </option>";
        if (mode==0) {
            text="";
            for (let i = 0; i < Math.ceil(robeStorage.length/20);i++) {
                text+="<option value=\""+(i+1)+"\"> Page "+(i+1)+"</option>";
            }
            prevMode=mode;
        } else {
            if (storage!=null) {
            text="";   
                for (let i = 0; i < Math.ceil(storage.length/20);i++) {
                    text+="<option value=\""+(i+1)+"\"> Page "+(i+1)+"</option>";
                }
                prevMode=mode;
            }
        }
        pageSelect.innerHTML=text;
    }
    curMode=mode;
    await clearUrls();
    let result = "";
    if (mode==0) {
        /*
        let brCount = 0;
        for (let i = (page-1)*20; (i-(page-1)*20<20)&&(i<robeStorage.length); i++) {
            let tmpCount = 2;
            let tmpStr = toSpanArr(robeStorage[order?robeStorage.length-1-i:i][0],true).match(/<[bB][rR]>/g);
            tmpCount+=tmpStr==null?0:tmpStr.length;
            tmpStr = toSpanArr(robeStorage[order?robeStorage.length-1-i:i][1],true).match(/<[bB][rR]>/g);
            tmpCount+=tmpStr==null?0:tmpStr.length;
            brCount=Math.max(brCount,tmpCount);
        }
        brCount=Math.min(8,brCount);
        */
        for (let i = (page-1)*20; (i-(page-1)*20<20)&&(i<robeStorage.length); i++) {
            result+="<div class=\"robeChild\" onClick=selectRobe("+(i-((page-1)*20))+");>";
            let tmpCount = 2;
            let tmpStr = toSpanArr(robeStorage[order?robeStorage.length-1-i:i][0],true);
            await customImage(await toArr(order?robeStorage.length-1-i:i));
            let blob = await new Promise((x)=>{bufferCanvas.toBlob((blob)=>{x(blob)})});
            let url = URL.createObjectURL(blob);
            urlList.push(url);
            result+="<img src=\""+url+"\" style=\"width:90%;height:width;\"></img><br>";
            result+=tmpStr+"<br>";
            tmpStr=tmpStr.match(/<[bB][rR]>/g);
            tmpCount+=tmpStr==null?0:tmpStr.length;
            tmpStr = toSpanArr(robeStorage[order?robeStorage.length-1-i:i][1],true)
            result+=tmpStr+"<br>";
            tmpStr=tmpStr.match(/<[bB][rR]>/g);
            tmpCount+=tmpStr==null?0:tmpStr.length;
            result+="<span style=\"color:#FFFFFF;\">Made by: </span>";
            let maker = robeStorage[order?robeStorage.length-1-i:i][2];
            if (maker.length==0) {
                maker="Uknown";
            }
            result+=toSpanArr(maker)+"<br>";
            //while (tmpCount<brCount) {
            //    result+="<br>";
            //    tmpCount++;
            //}
            result+="</div>";
        }
    } else {
        if (storage==null) {
            let xhr = new XMLHttpRequest();
            xhr.open("GET","robes.png");
            xhr.onload=function(event) {
                console.log(xhr);
                storage=xhr.response;
                toBlob(storage);
                let filtered = [];
                for (let i = 0; i < storage.length;) {
                    let count = 0n;
                    for (let l = 0; l<4 && i < storage.length; l++) {
                        let po = storage.charCodeAt(i++)&0x7F;
                        if (po>=0xd) po-=1;
                        if (po>=0xa) po-=1;
                        count=(count<<7n)|BigInt(po);
                    }
                    count=Number.parseInt(count);
                    console.log(count);
                    let curstr = "";
                    for (let l = 0; (l < count)&&(i<storage.length); l++) {
                        curstr+=(storage[i++]);
                    }
                    filtered.push(join(toMax(curstr)));
                }
                lastdata=filtered;
                let tmpBuf = [];
                let actual = [];
                for (let i = 0; i < filtered.length; i++) {
                for (let l = 0; l < filtered[i].length;) {
                    console.log(l,filtered[i].length);
                    let count = 0n;
                    for (let l1 = 0; l1<3 && l < filtered[i].length; l1++) {
                        count=(count<<8n)|BigInt(filtered[i].charCodeAt(l++)&0xFF);
                    }
                    count=Number.parseInt(count);
                    console.log(count);
                    let curstr = "";
                    for (let l1 = 0; (l1 < count) && (l<filtered[i].length); l1++) {
                        curstr+=filtered[i][l++];
                    }
                    console.log(curstr);
                    if (curstr=="EOF") {
                        if (tmpBuf.length>3) actual.push(tmpBuf);
                        tmpBuf=[];
                        break;;
                    }
                    tmpBuf.push(curstr);
                }
                tmpBuf=[];
                }
                console.log(tmpBuf,actual);
                storage=actual;
                working=false;
            }
            window.setTimeout(showRobes,200);
            working=true;
            xhr.send();
            return;
        }
        let brCount = 0;
        for (let i = (page-1)*20; (i-(page-1)*20<20)&&(i<storage.length); i++) {
            let tmpCount = 2;
            let tmpStr = toSpanArr(storage[order?storage.length-1-i:i][0],true).match(/<[bB][rR]>/g);
            tmpCount+=tmpStr==null?0:tmpStr.length;
            tmpStr = toSpanArr(storage[order?storage.length-1-i:i][1],true).match(/<[bB][rR]>/g);
            tmpCount+=tmpStr==null?0:tmpStr.length;
            brCount=Math.max(brCount,tmpCount);
        }
        brCount=Math.min(8,brCount);
        for (let i = (page-1)*20; (i-(page-1)*20<20)&&(i<storage.length); i++) {
            result+="<div class=\"robeChild\" onClick=selectRobe("+(i-((page-1)*20))+")>";
            let tmpCount = 2;
            let tmpStr = toSpanArr(storage[order?storage.length-1-i:i][0],true);
            result+=tmpStr+"<br>";
            tmpStr=tmpStr.match(/<[bB][rR]>/g);
            tmpCount+=tmpStr==null?0:tmpStr.length;
            tmpStr=toSpanArr(storage[order?storage.length-1-i:i][1],true);
            result+=tmpStr+"<br>";
            tmpStr=tmpStr.match(/<[bB][rR]>/g);
            tmpCount+=tmpStr==null?0:tmpStr.length;
            while (tmpCount<brCount) {
                tmpCount++;
                result+="<br>";
            }
            result+="<span style=\"color:#FFFFFF\">Made by: </span>";
            let maker = storage[order?storage.length-1-i:i][2];
            if (maker.length==0) {
                maker="Unknown";
            }
            result+=toSpanArr(maker)+"<br>";
            await customImage(await toGArr(order?storage.length-1-i:i));
            let blob = await new Promise((x)=>{bufferCanvas.toBlob((blob)=>{x(blob)})});
            let url = URL.createObjectURL(blob);
            urlList.push(url);
            result+="<img src=\""+url+"\" style=\"width:90%;height:width;\"></img></div>";
        }
    }
    robeDisplay.style.display="grid";
    robeDisplay.innerHTML=result;
}
function selectRobe(id) {
    console.log(id);
    let divs = document.getElementsByClassName("robeChild");
    for (let i = 0; i < divs.length; i++) {
        if (i==id) {
            divs[i].style="outline:2px solid #80FF80; background-color:#505050";
            continue;
        }
        divs[i].style="";
    }
    loadRobe(curMode==0?(order?robeStorage.length-(page-1)*20-id-1:(page-1)*20+id):(order?storage.length-(page-1)*20-id-1:(page-1)*20+id));
    window.scrollTo(0,0);
}
let nextCount = -1;
function getNext() {
    console.log(nextCount);
    for (let i = 0; i < testImageColorArray.length; i++) {
        if (i==nextCount) {
            testImageColorArray[i]=256*256*256*256-1;
            continue;
        }
        if (i==27) {
            testImageColorArray[i]=0;
            continue;
        }
        testImageColorArray[i]=255;    
    }
    nextCount++;
    if (nextCount>testImageColorArray.length) nextCount=-1;
    drawImage();
}
var lastSelectedRobe = -1;
function customImage(arr) {
    bufferCanvas.width=102;
    bufferCanvas.height=102;
    let ctx1 = bufferCanvas.getContext("2d");
    if (arr==null || arr.length!=testImageColorArray.length) {
        console.log("Invalid");
        arr=testImageColorArray;
    }
    for (let x = 0; x < 34; x++) {
        let lx = x-7;
        if (x<7) {
            lx=0;
        }
        if (x>25) {
            lx=0;
        }
        for (let y = 0; y < 34; y++) {
            let idt = testImageIndexArray[(1+y)*imageWidth+lx];
            ctx1.fillStyle=toColor(arr[idt]);
            ctx1.fillRect(x*3,y*3,3,3);
        }
    }
}
function updateText() {
    hasChanged=true;
    let str = document.getElementById("displayName").value;
    if (str.length!=stringSanitizer(str).length) document.getElementById("displayNameig").innerHTML="&nbsp;&nbsp;"+toSpanArr(str);
    str = document.getElementById("description").value;
    if (str.length!=stringSanitizer(str).length) document.getElementById("descriptionig").innerHTML="&nbsp;&nbsp;"+toSpanArr(str);
}
function deleteRobe(update=false) {
    if (lastSelectedRobe==-1 || lastSelectedRobe>=robeStorage.length) return;
    let newStor = [];
    for (let i = 0; i < robeStorage.length; i++) {
        if (i!=lastSelectedRobe) {
            newStor.push(robeStorage[i]);
        } else {
            newStor.push(null);
        }
    }
    robeStorage=newStor;
    storeRobes();
    loadRobes(update);
}
function replaceRobe(update=false) {
    //deleteRobe();
    if (lastSelectedRobe==-1 || lastSelectedRobe>=robeStorage.length) return;
    addRobe(false,lastSelectedRobe);
    if (update) showRobes(0);
}
function robeSel() {
    let rsl = document.getElementById("robeSelect").value;
    if (rsl=="None") return;
    lastSelectedRobe = parseInt(rsl.slice(4));
    loadRobe(lastSelectedRobe);
}
let robeStorage = [];
function loadRobes(update=false) {
    lastSelectedRobe=-1;
    robeStorage=[];
    let str = window.localStorage.getItem("x");
    if (str==null) return;
    let tmpBuf = [];
    let actual = [];
    let rsl = document.getElementById("robeSelect");
    rsl.innerHTML="<option value=\"None\">--Stored Robes--</option>";
    let o = 0;
    for (let i = 0; i < str.length;) {
        let count = 0n;
        for (let l = 0; l<3 && i < str.length; l++) {
            count=(count<<8n)|BigInt(str.charCodeAt(i++)&0xFF);
        }
        count=Number.parseInt(count);
        let curstr = "";
        for (let l = 0; (l < count) && (i<str.length); l++) {
            curstr+=str[i++];
        }
        if (curstr=="EOF") {
            if (tmpBuf.length>0) actual.push(tmpBuf);
            tmpBuf=[];
            continue;
        }
        if (tmpBuf.length==0) {
            let option = "<option value=\"robe"+(o++)+"\">";
            option+=stringSanitizer(curstr)+"</option>";
            rsl.innerHTML+=option;
        }
        tmpBuf.push(curstr);
    }
    robeStorage=actual;
    if (update) showRobes(0);
}
function toSpanArr(string,newLines=false) {
    let out = "<span style=\"color:#FFFFFF\">";
    let spanCount = 0;
    for (let i = 0; i < string.length; i++) {
        if (newLines && string[i]=="\\" && string[i+1]=="n") {
            out+="<br>";
            i+=1;
            continue;
        } 
        if (string[i]=="<") {
            if (i+1<string.length && string[i+1]=="/") {
                let val = string.indexOf("color",i+1);
                if (val==i+2 && spanCount>0) {
                    out+="</span>";
                    spanCount--;
                }
                for (let l = i; l < string.length; l++) {
                    if (string[l]==">") {
                        i=l;
                        break;
                    }
                }
                continue;
            }
            let val = string.indexOf("color",i+1);
            if (val==i+1) {
                if (i+6<string.length && string[i+6]=="=") {
                    let tmpStr = "";
                    for (let l = i+7; l < string.length; l++) {
                        if (string[l]==">") {
                            i=l;
                            break;
                        }
                        tmpStr+=string[l];
                    }
                    if (tmpStr.length==9) {
                        while (spanCount>0) {
                            out+="</span>";
                            spanCount--;
                        }
                        tmpStr=tmpStr.slice(1,tmpStr.length-1);
                        out+="<span style=\"color:"+tmpStr+"\">";
                        spanCount++;
                    }
                } else {
                    for (let l = i; l < string.length; l++) {
                        if (string[l]==">") {
                            i=l;
                            break;
                        }
                    }
                }
            }
            continue;
        }
        out+=string[i];
    }
    out+="</span>";
    return out;
}
function stringSanitizer(string) {
    let out = "";
    for (let i = 0; i < string.length; i++) {
        if (string[i]=="<") {
            for (let l = i+1; l < string.length; l++) {
                if (string[l]==">") {
                    i=l;
                    break;
                }
            }
            continue;
        }
        out+=string[i];
    }
    return out;
}
function storeRobes() {
    let res = "";
    for (let i = 0; i < robeStorage.length; i++) {
        if (robeStorage[i]==null || robeStorage[i].length==0) continue;
        for (let l = 0; l < robeStorage[i].length; l++) {
            res+=String.fromCharCode(((robeStorage[i][l].length)>>16)&0xFF);
            res+=String.fromCharCode(((robeStorage[i][l].length)>>8)&0xFF);
            res+=String.fromCharCode(((robeStorage[i][l].length))&0xFF);
            for (let o = 0; o < robeStorage[i][l].length; o++) {
                res+=robeStorage[i][l][o];
            }
        }
        res+="\x00\x00\x03EOF";
    }
    window.localStorage.setItem("x",res);
}
function rIDtoStr(id) {
    let res = "";
    for (let i = 0; i < robeStorage.length; i++) {
        if (i!=id) continue;
        if (robeStorage[i]==null || robeStorage[i].length==0) continue;
        for (let l = 0; l < robeStorage[i].length; l++) {
            res+=String.fromCharCode(((robeStorage[i][l].length)>>16)&0xFF);
            res+=String.fromCharCode(((robeStorage[i][l].length)>>8)&0xFF);
            res+=String.fromCharCode(((robeStorage[i][l].length))&0xFF);
            for (let o = 0; o < robeStorage[i][l].length; o++) {
                res+=robeStorage[i][l][o];
            }
        }
        res+="\x00\x00\x03EOF";
    }
    return res;
}
function addRobe(update=false,forceId=null) {
    let arr = [];
    if (document.getElementById("displayName").value=="") {
        document.getElementById("displayNameig").innerHTML="<span style=\"color:#FF4040\">&nbsp;&nbsp;Please enter a name for robe first</span>";
        return;
    }
    arr.push(document.getElementById("displayName").value);
    arr.push(document.getElementById("description").value);
    arr.push(document.getElementById("designer").value);
    let palStr = "";
    for (let i = 0; i < testImageColorArray.length; i++) {
        palStr+=String.fromCharCode((testImageColorArray[i]>>24)&0xFF);
        palStr+=String.fromCharCode((testImageColorArray[i]>>16)&0xFF);
        palStr+=String.fromCharCode((testImageColorArray[i]>>8)&0xFF);
        palStr+=String.fromCharCode((testImageColorArray[i])&0xFF);
    }
    arr.push(palStr);
    let tpop = stringSanitizer(arr[0]);
    let option = "<option value=\"robe"+robeStorage.length+"\">";
    option+=tpop+"</option>";
    document.getElementById("robeSelect").innerHTML+=option;
    if (forceId==null) {
        robeStorage.push(arr);
    } else {
        robeStorage[forceId]=arr;
    }
    storeRobes();
    if (update) showRobes(0);
}
function loadRobe(id) {
    if (curMode==0 && id>=robeStorage.length) return;
    if (curMode==1 && id>=storage.length) return;
    let robe = curMode==0?robeStorage[id]:storage[id];
    let palStr = robe[3];
    let o = 0n;
    let carr = [];
    for (let i = 0; i < palStr.length; i++) {
        o=(o<<8n)+BigInt(palStr.charCodeAt(i));
        if (i>0 && (1+i)%4==0) {
            carr.push(Number.parseInt(o));
            o=0n;
        }
    }
    if (carr.length!=testImageColorArray.length) return;
    testImageColorArray=carr;
    document.getElementById("displayName").value = robe[0];
    document.getElementById("description").value = robe[1];
    document.getElementById("designer").value = robe[2];
    updateText();
    drawImage();
}
var completeDO = false;
var helpLines = false;
let lastUsed = 0;
let enableArrowNavigation = false;
function keyDown(event) {
    if (!enableArrowNavigation) return;
    let key = event.key;
    if (key==null || !key.includes("Arrow") || event.target!=document.body) return;
    event.preventDefault();
    key=key.slice(5);
    if (key=="Left") {
        if (viewPortX<imageWidth) {
            if (offsetX>0) {
                offsetX--;
            }
        }
    }
    if (key=="Right") {
        if (viewPortX<imageWidth) {
            if (Math.abs(offsetX)+viewPortX<imageWidth) {
                offsetX++;
            }
        }
    }
    if (key=="Up") {
        if (viewPortY<imageHeight) {
            if (offsetY>0) {
                offsetY--;
            }
        }
    }
    if (key=="Down") {
        if (viewPortY<imageHeight) {
            if (Math.abs(offsetY)+viewPortY<imageHeight) {
                offsetY++;
            }
        }
    }
    let cur = Date.now();
    if (cur-lastUsed<16) return;
    lastUsed=cur;
    drawImage();
}
function updateLines() {
    helpLines=!helpLines;
    drawImage();
}
var eventBuffer = [];
var currentID = -1;
var eyeDropActive = false;
var eyeDropVision = document.getElementById("eyeDrop");
var eyeDropContext = eyeDropVision.getContext("2d");
function updateEyeTool(event) {
    if (eyeDropActive==false) return;
    let [x,y]=[(event.clientX-28),(event.clientY-28)];
    eyeDropVision.style.left=(event.pageX-28)+"px";
    eyeDropVision.style.top=(event.pageY-28)+"px";
    let bounds = canvas.getBoundingClientRect();
    let [cx,cy]=[x-bounds.x,y-bounds.y];
    if (cx+28<0 || cx+28>bounds.width || cy+28<0 || cy+28>bounds.height) {
        eyeDropContext.fillStyle="#000000";
        eyeDropContext.fillRect(0,0,eyeDropVision.width,eyeDropVision.height);
        return;
    }
    let imgdat1 = ctx.getImageData(cx+27,cy+27,3,3);
    let scale = 10;
    for (let y1 = 0; y1 < imgdat1.height; y1++) {
        for (let x1 = 0; x1 < imgdat1.width; x1++) {
            let color = Number.parseInt((BigInt(imgdat1.data[(y1*imgdat1.width+x1)*4])<<24n)+BigInt(imgdat1.data[(y1*imgdat1.width+x1)*4+1]<<16|imgdat1.data[(y1*imgdat1.width+x1)*4+2]<<8|imgdat1.data[(y1*imgdat1.width+x1)*4+3]));
            eyeDropContext.fillStyle=toColor(color);
            eyeDropContext.fillRect(x1*scale,y1*scale,scale,scale);
        }
    }
    eyeDropContext.fillStyle="#000000";
    eyeDropContext.fillRect(0,0,30,2);
    eyeDropContext.fillRect(0,28,30,2);
    eyeDropContext.fillRect(0,0,2,30);
    eyeDropContext.fillRect(28,0,2,30);
}
function eyeTrigger(event) {
    eyeDropActive=false;
    eyeDropVision.style.left="8000px";
    eyeDropVision.style.top="0px";
    eyeDropVision.style.display="none";
    let bounds = canvas.getBoundingClientRect();
    let [cx,cy]=[event.clientX-bounds.x-28,event.clientY-bounds.y-28];
    if (cx+28<0 || cx+28>bounds.width || cy+28<0 || cy+28>bounds.height) {
        return;
    }
    let imgdat1 = ctx.getImageData(cx+28,cy+28,1,1);
    let tmpCol = toColor(Number.parseInt((BigInt(imgdat1.data[0])<<24n)+BigInt(imgdat1.data[1]<<16|imgdat1.data[2]<<8|imgdat1.data[3])));
    color.value=tmpCol.slice(0,7);
    color2.value=tmpCol;
    document.getElementById("colorSlider").value=parseInt(tmpCol.slice(7),16);
}
function activateEyeDrop() {
    eyeDropActive=true;
    eyeDropVision.width=30;
    eyeDropVision.height=30;
    eyeDropVision.style.position="absolute";
    eyeDropVision.style.left="8000px";
    eyeDropVision.style.top="0px";
    eyeDropVision.style.display="block";
    eyeDropContext.fillStyle="#000000";
    eyeDropContext.fillRect(0,0,eyeDropVision.width,eyeDropVision.height);
}
function registerEvent(id,oldC,newC) {
    if (oldC==newC) return;
    if (eventBuffer.length>1000) {
        eventBuffer.shift();
        currentID--;
    }
    while (currentID+1>eventBuffer.length) {
        currentID--;
    }
    if (currentID<eventBuffer.length-1) {
        eventBuffer=eventBuffer.slice(0,Math.max(0,currentID+1));
    }
    eventBuffer.push([id,oldC,newC]);
    currentID++;
}
function undo() {
    if (currentID==-1 || currentID>=eventBuffer.length) return;
    let lastevent = eventBuffer[currentID];
    testImageColorArray[lastevent[0]]=lastevent[1];
    currentID--;
    drawImage();
}
function redo() {
    if (currentID+1>=eventBuffer.length) return;
    currentID++;
    let lastevent = eventBuffer[currentID];
    testImageColorArray[lastevent[0]]=lastevent[2];
    drawImage();
}
var colorPickMode = false;
var colorPickZone = ["#FFFFFFFF","#FFFFFFFF","#FFFFFFFF","#FFFFFFFF","#FFFFFFFF","#FFFFFFFF","#FFFFFFFF","#FFFFFFFF","#FFFFFFFF","#FFFFFFFF","#FFFFFFFF","#FFFFFFFF"];
let colorFields = document.getElementsByClassName("colorField");
function btnChange() {
    if (document.getElementById("scratch").value=="Currently in replace color mode") {
        document.getElementById("scratch").value="Currently in pick color mode";
        resetColorSwatches("black");
        colorPickMode=true;
    } else {
        document.getElementById("scratch").value="Currently in replace color mode";
        resetColorSwatches("red");
        colorPickMode=false;
    }
}
let testImage = new Uint8Array([0, 56, 0, 36, 28, 100, 100, 100, 255, 188, 154, 106, 255, 150, 115, 65, 255, 147, 86, 16, 255, 125, 80, 28, 255, 106, 69, 27, 255, 0, 0, 0, 0, 62, 75, 36, 255, 46, 55, 26, 255, 1, 1, 1, 255, 2, 2, 2, 255, 3, 3, 3, 255, 130, 166, 50, 255, 113, 147, 36, 255, 102, 136, 20, 255, 98, 125, 23, 255, 87, 111, 22, 255, 82, 102, 26, 255, 63, 77, 23, 255, 34, 41, 13, 255, 251, 207, 0, 255, 244, 202, 0, 255, 203, 86, 60, 255, 186, 254, 254, 255, 10, 10, 10, 255, 234, 200, 152, 255, 34, 34, 34, 255, 0, 0, 0, 0, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 12, 12, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 12, 12, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 12, 12, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 12, 12, 12, 12, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 12, 12, 12, 12, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 12, 12, 12, 12, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 13, 13, 12, 12, 13, 12, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 12, 13, 13, 13, 12, 12, 6, 6, 27, 27, 27, 27, 27, 27, 27, 6, 12, 13, 13, 12, 13, 12, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 13, 13, 13, 12, 13, 13, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 13, 13, 13, 13, 13, 13, 17, 17, 6, 27, 27, 27, 27, 27, 27, 27, 6, 13, 13, 13, 13, 13, 13, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 13, 13, 11, 11, 13, 13, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 13, 13, 13, 13, 13, 11, 11, 17, 6, 27, 27, 27, 27, 27, 27, 6, 6, 13, 13, 13, 13, 13, 13, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 13, 13, 11, 11, 11, 11, 13, 13, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 13, 13, 13, 13, 13, 11, 11, 11, 17, 6, 27, 27, 27, 27, 27, 27, 6, 13, 13, 13, 13, 13, 13, 13, 13, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 13, 11, 22, 11, 11, 22, 11, 13, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 17, 17, 13, 13, 11, 11, 22, 11, 17, 6, 27, 27, 27, 27, 27, 27, 6, 13, 13, 14, 14, 14, 14, 13, 13, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 17, 11, 25, 25, 25, 25, 11, 17, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 17, 18, 18, 13, 25, 25, 25, 17, 6, 27, 27, 27, 27, 27, 27, 6, 17, 14, 14, 14, 14, 16, 14, 17, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 17, 11, 25, 25, 11, 17, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 17, 18, 18, 18, 25, 17, 6, 6, 27, 27, 27, 27, 27, 27, 6, 6, 17, 17, 17, 16, 16, 17, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 12, 14, 12, 12, 12, 14, 18, 12, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 13, 13, 13, 17, 17, 18, 6, 6, 27, 27, 27, 27, 27, 27, 6, 6, 13, 17, 15, 15, 15, 15, 17, 13, 6, 6, 27, 27, 27, 27, 27, 27, 27, 6, 6, 12, 14, 16, 14, 14, 14, 14, 21, 17, 12, 6, 6, 27, 27, 27, 27, 27, 27, 27, 6, 13, 14, 14, 13, 14, 16, 12, 6, 6, 27, 27, 27, 27, 27, 6, 6, 13, 14, 14, 15, 15, 15, 15, 14, 14, 13, 6, 6, 27, 27, 27, 27, 27, 27, 6, 12, 17, 14, 14, 16, 16, 16, 16, 14, 14, 18, 12, 6, 27, 27, 27, 27, 27, 27, 6, 6, 14, 14, 8, 8, 8, 14, 16, 16, 6, 27, 27, 27, 27, 27, 6, 13, 13, 14, 14, 14, 15, 15, 14, 14, 14, 13, 13, 6, 27, 27, 27, 27, 27, 27, 6, 14, 14, 8, 8, 14, 14, 14, 14, 8, 8, 14, 14, 6, 27, 27, 27, 27, 27, 27, 6, 13, 14, 8, 7, 7, 7, 8, 13, 13, 6, 27, 27, 27, 27, 27, 6, 13, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 13, 6, 27, 27, 27, 27, 27, 27, 6, 14, 8, 7, 8, 8, 10, 10, 8, 8, 7, 8, 14, 6, 27, 27, 27, 27, 27, 27, 6, 14, 14, 7, 7, 7, 7, 7, 8, 10, 6, 27, 27, 27, 27, 27, 6, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 6, 27, 27, 27, 27, 27, 27, 6, 14, 8, 7, 7, 7, 10, 10, 7, 7, 7, 8, 14, 6, 27, 27, 27, 27, 27, 27, 6, 14, 7, 7, 7, 8, 8, 7, 7, 10, 6, 27, 27, 27, 27, 6, 6, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 6, 6, 27, 27, 27, 27, 6, 6, 14, 8, 8, 7, 7, 10, 10, 7, 7, 8, 8, 14, 6, 6, 27, 27, 27, 27, 6, 6, 14, 7, 7, 7, 8, 7, 7, 7, 10, 6, 27, 27, 27, 27, 6, 13, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 13, 6, 27, 27, 27, 27, 6, 14, 14, 2, 8, 7, 7, 10, 10, 7, 7, 8, 2, 14, 14, 6, 27, 27, 27, 27, 6, 13, 14, 19, 2, 7, 8, 7, 7, 7, 10, 6, 27, 27, 27, 27, 6, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 6, 27, 27, 27, 27, 6, 14, 14, 1, 19, 8, 7, 10, 10, 7, 8, 19, 1, 14, 14, 6, 27, 27, 27, 27, 6, 14, 14, 19, 1, 19, 7, 7, 7, 7, 10, 6, 27, 27, 27, 27, 6, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 6, 27, 27, 27, 6, 6, 14, 14, 0, 19, 3, 3, 20, 20, 3, 3, 19, 0, 14, 14, 6, 6, 27, 27, 6, 6, 14, 14, 19, 0, 19, 3, 3, 3, 3, 20, 6, 27, 27, 27, 6, 6, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 6, 6, 27, 27, 6, 14, 14, 14, 1, 19, 8, 8, 9, 9, 8, 8, 19, 1, 14, 14, 14, 6, 27, 27, 6, 14, 14, 14, 19, 2, 19, 8, 8, 8, 8, 9, 6, 27, 27, 27, 6, 13, 14, 14, 16, 14, 14, 14, 14, 14, 14, 14, 16, 14, 14, 14, 13, 6, 27, 27, 6, 14, 14, 14, 19, 19, 8, 7, 9, 9, 7, 8, 19, 19, 14, 14, 14, 6, 27, 27, 6, 14, 14, 14, 19, 19, 19, 7, 7, 7, 7, 9, 6, 27, 27, 27, 6, 14, 14, 14, 16, 14, 14, 14, 14, 14, 14, 14, 16, 14, 13, 14, 14, 6, 27, 27, 6, 14, 14, 19, 19, 8, 7, 9, 9, 9, 9, 7, 8, 19, 19, 14, 14, 6, 27, 27, 6, 14, 14, 14, 19, 19, 7, 7, 7, 7, 9, 9, 6, 27, 27, 27, 6, 14, 14, 14, 16, 14, 14, 14, 13, 14, 14, 14, 16, 14, 13, 14, 14, 6, 27, 27, 6, 6, 14, 19, 19, 7, 9, 9, 9, 9, 9, 9, 7, 19, 19, 14, 6, 6, 27, 27, 6, 6, 14, 14, 19, 19, 7, 7, 9, 9, 9, 9, 6, 27, 27, 27, 6, 6, 14, 16, 16, 14, 14, 14, 13, 14, 14, 14, 16, 16, 13, 14, 6, 6, 27, 27, 27, 6, 14, 19, 19, 9, 9, 9, 19, 19, 9, 9, 9, 19, 19, 14, 6, 27, 27, 27, 27, 6, 6, 14, 19, 19, 19, 9, 9, 9, 9, 9, 6, 27, 27, 27, 27, 6, 6, 6, 16, 16, 14, 14, 13, 13, 14, 14, 16, 16, 6, 6, 6, 27, 27, 27, 27, 6, 14, 6, 19, 9, 9, 9, 19, 19, 9, 9, 9, 19, 6, 14, 6, 27, 27, 27, 27, 27, 6, 6, 14, 19, 19, 9, 9, 9, 9, 9, 6, 27, 27, 27, 27, 27, 27, 6, 6, 16, 14, 14, 13, 13, 14, 14, 16, 6, 6, 27, 27, 27, 27, 27, 27, 6, 6, 6, 6, 9, 9, 9, 19, 19, 9, 9, 9, 6, 6, 6, 6, 27, 27, 27, 27, 27, 27, 6, 6, 6, 19, 9, 9, 9, 9, 9, 6, 27, 27, 27, 27, 27, 27, 27, 6, 6, 9, 9, 14, 13, 9, 9, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 9, 9, 6, 6, 9, 9, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 9, 9, 9, 9, 9, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 6, 9, 9, 6, 6, 9, 9, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 3, 6, 6, 6, 6, 3, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 9, 9, 9, 6, 3, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 3, 6, 6, 6, 6, 3, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 5, 6, 27, 27, 6, 5, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 3, 6, 6, 5, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 5, 6, 27, 27, 6, 5, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 5, 6, 27, 27, 6, 5, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 5, 6, 6, 5, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 5, 6, 27, 27, 6, 5, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 5, 6, 27, 27, 6, 5, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 5, 6, 6, 5, 6, 6, 27, 27, 27, 27, 27, 27, 27, 6, 6, 5, 6, 27, 27, 6, 5, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 4, 5, 6, 27, 27, 6, 5, 4, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 5, 6, 6, 5, 4, 6, 27, 27, 27, 27, 27, 27, 27, 6, 4, 5, 6, 27, 27, 6, 5, 4, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 6, 6, 27, 27, 6, 6, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 5, 4, 6, 6, 6, 6, 27, 27, 27, 27, 27, 27, 27, 6, 6, 6, 6, 27, 27, 6, 6, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27]);
let color = document.getElementById("inColor");
let color2 = document.getElementById("hexColor");
let lastColor = null;
function resetColorSwatches(color) {
    if (color==null) {
        if (lastColor==null) return;
        color=lastColor;
    }
    lastColor=color;
    let str = "4px solid "+color;
    for (let i = 0; i < colorFields.length; i++) {
        colorFields[i].style.outline=str;
    }
}
function colorPick(id) {
    let curColor = "";
    if (colorPickMode) {
        resetColorSwatches("black");
        curColor = colorPickZone[id];
        color.value=curColor.slice(0,7);
        color2.value=curColor;
        document.getElementById("colorSlider").value=parseInt(curColor.slice(7),16);
        colorFields[id].style.outline="4px solid #A0FFA0";
        return;
    }
    curColor=color2.value;
    colorPickZone[id]=curColor;
    colorFields[id].style.backgroundColor=curColor;
}
function alphaUpdate() {
    resetColorSwatches();
    let val = parseInt(document.getElementById("colorSlider").value).toString(16).toUpperCase();
    while (val.length<2) val="0"+val;
    color2.value=color2.value.slice(0,7)+val;
}
let canvas = document.getElementById("test");
let ctx = canvas.getContext("2d",{"willReadFrequently":true});
let testImageColorArray = [];
let testImageIndexArray = [];
let skipArray = [];
let skipIndex = [];
let skipCount = 0;
let imageHeight = 0;
let imageWidth = 0;
let offsetX = 0;
let offsetY = 0;
let iOffsetX = 0;
let iOffsetY = 0;
let pixelScaleX = 16;
let pixelScaleY = 16;
let viewPortX = 56;
let viewPortY = 36;
let someValue = 16;
//full red = 28;
window.onresize = function(){
    if (window.innerHeight<64) return;
    someValue=Math.max(1,Math.ceil(window.innerHeight*0.02));
    checkScale();
    canvas.height=pixelScaleY*viewPortY;
    canvas.width=pixelScaleX*(viewPortX-skipCount);
    drawImage();
}
let ignoreScale = false;
function checkScale() {
    if (ignoreScale) {
        return;
    }
    for (let i = 0; i < someValue && pixelScaleX*(viewPortX-skipCount)<(0.9*window.innerWidth); i++) {
        pixelScaleX++;
        if (pixelScaleX>=someValue) break;
    }
    for (let i = 0; i < someValue && pixelScaleY*(viewPortY-skipCount)<(0.9*window.innerHeight); i++) {
        pixelScaleY++;
        if (pixelScaleY>=someValue) break;
    }
    for (let i = 0; i < someValue && pixelScaleX>1 && pixelScaleX*(viewPortX-skipCount)>(0.9*window.innerWidth); i++) {
        pixelScaleX--;
    }
    for (let i = 0; i < someValue && pixelScaleY>1 && pixelScaleY*viewPortY>(0.9*window.innerHeight); i++) {
        pixelScaleY--;
    }
    pixelScaleX=Math.min(pixelScaleX,pixelScaleY);
    if (pixelScaleX>1) pixelScaleX=pixelScaleX&0xFE;
    pixelScaleY=pixelScaleX;
}
window.onload = function(){
    loadRobes();
    someValue=Math.max(1,Math.ceil(window.innerHeight*0.019));
    checkScale();
    canvas.height=pixelScaleY*viewPortY;
    canvas.width=pixelScaleX*(viewPortX-skipCount);
    let tmpCount = 0;
    imageWidth = testImage[tmpCount++]<<8|testImage[tmpCount++];
    imageHeight = testImage[tmpCount++]<<8|testImage[tmpCount++];
    let loop = testImage[tmpCount++];
    testImageColorArray=[];
    testImageIndexArray=[];
    for (let i = 0; i < loop; i++) {
        testImageColorArray[testImageColorArray.length]=Number.parseInt(BigInt(testImage[tmpCount++])<<24n|BigInt(testImage[tmpCount++]<<16|testImage[tmpCount++]<<8|testImage[tmpCount++]));
    }
    for (let i = 0; i < imageHeight*imageWidth; i++) {
        testImageIndexArray[testImageIndexArray.length]=testImage[tmpCount++];
    }
    testImageIndexArray=new Uint8Array(testImageIndexArray);
    /*
    let tmpList15 = [];
    let tmpList16 = [];
    for (let i = 0; i < testImageColorArray.length; i++) {
        tmpList15[i]=testImageColorArray[i]>>24&0xFF;
    }
    tmpList15.sort();
    for (let i = 0; i < testImageColorArray.length; i++) {
        tmpList16[tmpList15.indexOf(testImageColorArray[i]>>24&0xFF)] = testImageColorArray[i];
    }
    for (let i = 0; i < testImageIndexArray.length; i++) {
        testImageIndexArray[i] = tmpList16.indexOf(testImageColorArray[testImageIndexArray[i]]);
    }
    //testImageColorArray=tmpList16;
    */
    //testImageColorArray = [1684301055, 3164236543, 2524135935, 2471891199, 2102402303, 1782914047, 0, 1045112063, 775363327, 16843263, 33686271, 50529279, 2191930111, 1905468671, 1720194303, 1652365311, 1466898175, 1382423295, 1062017023, 573115903, 4224647423, 4106879231, 3411426559, 3137273599, 168430335, 3939014911, 572662527, 0];
    


    //testImageColorArray=[2088796159,3685785599,2121096703,2121096703,1633045503,1633045503,4292214815,1347839743,1044467711,255,255,255,4294967295,3554137855,2795939583,2290649343,4261412863,2189853951,1465341951,606481663,4292635903,4292635647,4261412863,255,255,255,255,255];
    //testImageColorArray=[855835647, 255, 255, 855835647, 255, 421075455, 13619008, 1717987071, 858993663, 255, 255, 255, 421075455, 421075455, 255, 255, 255, 421075455, 255, 421075455, 4291559679, 4288217343, 13421823, 3137273599, 168430335, 255, 572662527, 0x00E3E309];
    /*
    let otherArrayTest = [];
    let otherOffset = 0;
    for (let i = 0; i < testImageColorArray.length; i++) {
        otherArrayTest[i]=testImageColorArray[(otherOffset+i)%testImageColorArray.length];
    }
    testImageColorArray=otherArrayTest;
    */
    drawImage();
};
function createNewArray() {
    let newArr = [];
    skipCount=0;
    for (let i = 0; i < skipIndex.length; i++) {
        skipCount+=skipIndex[i];
    }
    let scratchPad = imageWidth+1;
    newArr.push(scratchPad>>8);
    newArr.push(scratchPad&0xFF);
    imageHeight++;
    newArr.push(imageHeight>>8);
    newArr.push(imageHeight&0xFF);
    imageHeight--;
    newArr.push(testImageColorArray.length);
    for (let i = 0; i < testImageColorArray.length; i++) {
        for (let l = 0; l < 4; l++) {
            newArr.push((testImageColorArray[i]>>((3-l)*8))&0xFF);
        }
    }
    for (let y = 0; y < imageHeight; y++) {
        newArr.push(27);
        if (y==0) {
            for (let x = 0; x < imageWidth+1; x++) {
                newArr.push(27);
            }
        }
        for (let x = 0; x < imageWidth; x++) {
            if (skipArray.includes(x)) {
                x+=skipIndex[skipArray.indexOf(x)];
            }
            newArr.push(testImageIndexArray[imageWidth*y+x]);
        }
    }
    testImage=new Uint8Array(newArr);
    skipArray=[];
    skipIndex=[];
    offsetX=0;
    offsetY=0;
    window.onload();
    let outStr = "[";
    for (let i = 0; i < newArr.length; i++) {
        outStr+=newArr[i];
        if (i+1<newArr.length) {
            outStr+=", ";
        }
    }
    outStr+="]";
    console.log(outStr);
}
function testFile() {
    let tmp = document.getElementById("testInputFile");
    if (tmp==null) return;
    if (tmp.files.length==0) return;
    let img = document.getElementById("testImage");
    img.onload = function(){
        if (img.width*img.height>=16000*16000) return;
        bufferCanvas.width = img.width;
        bufferCanvas.height = img.height;
        let ctx1 = bufferCanvas.getContext("2d");
        ctx1.drawImage(img,0,0);
        URL.revokeObjectURL(img.src);
        for (let i = 0; i < 255; i++) {
            i--;
            i++;
        }
        let imageData = ctx1.getImageData(0,0,img.width,img.height);
        if (img.width==56 && img.height==2) {
            for (let i = 0; i < 56; i++) {
                let cur = Number.parseInt(BigInt(imageData.data[i*4])<<24n | BigInt((imageData.data[i*4+1]<<16)|(imageData.data[i*4+2]<<8)|(imageData.data[i*4+3])));
                testImageColorArray[i>>1]=cur;
                i++;
            }
        } else {
            let colArray = [];
            let tmpArr = [];
            let valid = true;
            /*
            for (let l = 0; l < img.height; l++) {
                for (let i = 0; i < img.width; i++) {
                    let id = Number.parseInt(BigInt(imageData.data[(l*img.width+i)*4])<<24n | BigInt((imageData.data[(l*img.width+i)*4+1]<<16)|(imageData.data[(l*img.width+i)*4+2]<<8)|(imageData.data[(l*img.width+i)*4+3])));
                    let pos = colArray.indexOf(id);
                    if (pos==-1) {
                        if (colArray.length>=256*256) {
                            l=Number.MAX_SAFE_INTEGER;
                            valid=false;
                            break;
                        }
                        pos=colArray.push(id)-1;
                    }
                    tmpArr.push(pos);
                }
            }
            */
            for (let l = 0; l < img.height; l++) {
                for (let i = 0; i < img.width; i++) {
                    let id = Number.parseInt(BigInt(imageData.data[(l*img.width+i)*4])<<24n | BigInt((imageData.data[(l*img.width+i)*4+1]<<16)|(imageData.data[(l*img.width+i)*4+2]<<8)|(imageData.data[(l*img.width+i)*4+3])));
                    let pos = colArray.indexOf(id);
                    if (pos==-1) {
                        if (colArray.length>=256*256) {
                            l=Number.MAX_SAFE_INTEGER;
                            valid=false;
                            break;
                        }
                        pos=colArray.push(id)-1;
                    }
                }
            }
            if (!valid) return;
            let sorted = [];
            for (let i = 0; i < colArray.length; i++) {
                sorted[(colArray[i]>>24)&0xFF]=colArray[i];
            }
            sorted = sorted.filter((x)=>{return x!=null});
            for (let l = 0; l < img.height; l++) {
                for (let i = 0; i < img.width; i++) {
                    let id = Number.parseInt(BigInt(imageData.data[(l*img.width+i)*4])<<24n | BigInt((imageData.data[(l*img.width+i)*4+1]<<16)|(imageData.data[(l*img.width+i)*4+2]<<8)|(imageData.data[(l*img.width+i)*4+3])));
                    tmpArr.push(sorted.indexOf(id));
                }
            }
            return;
            testImageColorArray=colArray;
            testImageIndexArray=tmpArr;
            viewPortX=Math.min(128,img.width);
            viewPortY=Math.min(128,img.height);
            offsetX=0;
            offsetY=0;
            imageWidth=img.width;
            imageHeight=img.height;
            someValue=Math.max(1,Math.ceil(window.innerHeight*0.019));
            checkScale();
            canvas.height=pixelScaleY*viewPortY;
            canvas.width=pixelScaleX*(viewPortX-skipCount);
        }
        drawImage();
    };
    img.src=URL.createObjectURL(tmp.files[tmp.files.length-1]);
}
function testToHex() {
    resetColorSwatches();
    color2.value=color.value.toUpperCase()+"FF";
    document.getElementById("colorSlider").value="255";
}
function testHex() {
    resetColorSwatches();
    let stringIn = color2.value.toUpperCase();
    let stringOut = "";
    for (let i = 0; i < stringIn.length; i++) {
        switch (stringIn.charAt(i)) {
            case "A":
            case "B":
            case "C":
            case "D":
            case "E":
            case "F":
            case "0":
            case "1":
            case "2":
            case "3":
            case "4":
            case "5":
            case "6":
            case "7":
            case "8":
            case "9":
                stringOut+=stringIn.charAt(i);
            default:
                break;
        }
    }
    while (stringOut.length<6) stringOut="0"+stringout;
    if (stringOut.length==6 || stringOut.length==8) {
        if (stringOut.length==6) stringOut+="FF";
        color2.value="#"+stringOut;
        color.value=("#"+stringOut).slice(0,7);
    }
    document.getElementById("colorSlider").value=parseInt(stringOut.slice(6),16);
}
function testFunction(e) {
    if (e==null) return;
    let [x,y] = [Math.floor(e.offsetX/pixelScaleX),Math.floor(e.offsetY/pixelScaleY)];
    x+=iOffsetX;
    y+=iOffsetY;
    x+=offsetX;
    y+=offsetY;
    if (x<0) x=0;
    if (y<0) y=0;
    let save = 0;
    for (let i = 0; i < skipArray.length; i++) {
        if (skipArray[i]<=x) {
            save=skipIndex[i];
        }
    }
    x+=save;
    let index = testImageIndexArray[y*imageWidth+x];
    save = testImageColorArray[index];
    if (color2.value.substring(1).length==6) {
        testImageColorArray[index]=Number.parseInt(BigInt(parseInt(color.value.substring(1),16))<<8n);
    }
    if (color2.value.substring(1).length==8) {
        testImageColorArray[index]=Number.parseInt(color2.value.substring(1),16);    
    }
    registerEvent(index,save,testImageColorArray[index]);
    drawImage(index);
}
let lookupCA = [];
let lookupCB = [];
function toColor(id) {
    let tmp = lookupCA.indexOf(id);
    if (tmp!=-1) {
        return lookupCB[tmp];
    }
    let [r,g,b,a] = [(id>>24)&0xFF,(id>>16)&0xFF,(id>>8)&0xFF,id&0xFF];
    [r,g,b,a] = [r.toString(16).toUpperCase(),g.toString(16).toUpperCase(),b.toString(16).toUpperCase(),a.toString(16).toUpperCase()];
    r = r.length==2?r:"0"+r;
    g = g.length==2?g:"0"+g;
    b = b.length==2?b:"0"+b;
    a = a.length==2?a:"0"+a;
    if (lookupCA.length>65536) {
        lookupCA=lookupCA.slice(10000);
        lookupCB=lookupCB.slice(10000);
    }
    lookupCA.push(id);
    lookupCB.push("#"+r+g+b+a);
    return "#"+r+g+b+a;
}
function drawImage(something=-1) {
    ctx.fillStyle="#000000FF";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    let bgRect = [pixelScaleX>>1,pixelScaleY>>1];
    for (let i = 0;(i<100)&&(bgRect[0]==0 || (bgRect[0]/canvas.width)<0.01);i++) {
        bgRect[0]++;
        bgRect[1]++;
    }
    for (let i = 0;(i<100)&&(pixelScaleX>0 && bgRect[0]>1 && (!(bgRect[0]%pixelScaleX==0 || pixelScaleX%bgRect[0]==0)));i++) {
        bgRect[0]--;
        bgRect[1]--;
    }
    if (bgRect[0]==pixelScaleX) {
        if ((bgRect[0]/canvas.width)<0.01) {
            bgRect[0]*=2;
            bgRect[1]*=2;
        } else {
            bgRect[0]/=2;
            bgRect[1]/=2;
        }
    }
    for (let x = 0; x < Math.ceil(canvas.width/bgRect[0]); x++) {
        for (let y = 0; y < Math.ceil(canvas.height/bgRect[1]); y++) {
            if ((x+y)&1) {
                ctx.fillStyle="#505050FF";
            } else {
                ctx.fillStyle="#404040FF";
            }
            ctx.fillRect(x*bgRect[0],y*bgRect[1],bgRect[0],bgRect[1]);
        }
    }
    let negX = 0;
    for (let x = 0; x <= viewPortX; x++) {
        if (skipArray.indexOf(x)!=-1) {
            negX+=skipIndex[skipArray.indexOf(x)];
        }
        for (let y = 0; y <= viewPortY; y++) {
            let colX = x+negX;
            let colY = y;
            colX+=offsetX;
            colY+=offsetY;
            if (colX<offsetX) {
                //colX=0;
                //colY=0;
            } else {
                //colX+=offsetX;
            }
            if (colY<offsetY) {
                //colX=0;
                //colY=0;
            } else {
                //colY+=offsetY;
            }
            if (colY>=imageHeight || colX>=imageWidth) {
                colX=0;
                colY=0;
            }
            let idt = testImageIndexArray[(iOffsetY+colY)*imageWidth+(iOffsetX+colX)];
            //if (something>-1 && idt!=something) continue;
            ctx.fillStyle=toColor(testImageColorArray[idt]);
            ctx.fillRect(x*pixelScaleX,y*pixelScaleY,pixelScaleX,pixelScaleY);
        }
    }
    ctx.fillStyle="#FFFFFF";
    if (pixelScaleX<4 || !helpLines) return;
    for (let y = 0; y <= viewPortY; y++) {
        if (y>=imageHeight) continue;
        let prev = null;
        for (let x = 0; x <= viewPortX; x++) {
            if (x>=imageWidth) continue;
            let cur = testImageIndexArray[(y+offsetY)*imageWidth+(x+offsetX)];
            if (prev==null) {
                prev=cur;
                continue;
            }
            if (prev!=cur) {
                ctx.fillRect(x*pixelScaleX-1,y*pixelScaleY-1,2,pixelScaleY+2);
            }
            prev=cur;
        }
    }
    for (let x = 0; x <= viewPortX; x++) {
        if (x>=imageWidth) continue;
        let prev = null;
        for (let y = 0; y <= viewPortY; y++) {
            if (y>=imageHeight) continue;
            let cur = testImageIndexArray[(y+offsetY)*imageWidth+(x+offsetX)];
            if (prev==null) {
                prev=cur;
                continue;
            }
            if (prev!=cur) {
                ctx.fillRect(x*pixelScaleX-1,y*pixelScaleY-1,pixelScaleX+2,2);
            }
            prev=cur;
        }
    }
}
function updateBufferCanvas() {
    let context = bufferCanvas.getContext("2d");
    bufferCanvas.width=56;
    bufferCanvas.height=2;
    for (let i = 0; i < 28; i++) {
        context.fillStyle=toColor(testImageColorArray[i]);
        context.fillRect(i*2,0,2,2);
    }
}
function toRobeFile() {
    updateBufferCanvas();
    let text = bufferCanvas.toDataURL();
    let seperator = "***BREAK***";
    text=text.slice(text.indexOf("base64,")+7);
    let tmp = document.getElementById("description").value;
    for (let i = 0; i < tmp.length-1; i++) {
        if (tmp[i]=="\\" && tmp[i+1].toLowerCase()=="n") {
            tmp=tmp.slice(0,i).concat("\n".concat(tmp.slice(i+2)));
        }
    }
    text=document.getElementById("displayName").value+seperator+tmp+seperator+document.getElementById("designer").value+seperator+text;
    let blob = new Blob([text]);
    let a = document.createElement("a");
    let defaultName = "CustomRobe";
    if (document.getElementById("displayName").value.length>0) {
        defaultName=document.getElementById("displayName").value;
        if (defaultName.includes("<")) {
            defaultName="CustomRobe";
        }
    }
    a.download=defaultName+".robe";
    a.href=URL.createObjectURL(blob);
    a.click();
    URL.revokeObjectURL(a.href);
}
function savestrip() {
    updateBufferCanvas();
    bufferCanvas.toBlob((blob)=>{
        let a = document.createElement("a");
        a.download="Strip.png";
        a.href=URL.createObjectURL(blob);
        a.click();
        URL.revokeObjectURL(a.href);
    });
    let text = bufferCanvas.toDataURL();
    text=text.slice(text.indexOf("base64,")+7);
    console.log(text);
}
</script>
</body>
</html>