<html>
<head>
<style>
canvas {
    image-rendering: pixelated;
}
.colorField {
    width:8vmin;
    height:5vmin;
    outline:4px solid red;
    background-color: #FFFFFF;
}
#colorDiv {
    display:flex;
    gap:20px;
}
#colorSlider {
    width:min(512px,90vmin);
}
</style>
<title>Robes</title>
</head>
<body bgColor="#404040" text="#80FF80" onmousemove="updateEyeTool(event)">
<canvas id="test" width=512 height=512 onclick="testFunction(event);" style="outline:2px solid #808080"></canvas><br>
<input type="button" value="undo" onclick="undo()"><input type="button" value="redo" onclick="redo()" style="position:relative;left:20vmin;"><input type="button" value="Eyedrop tool" onclick="activateEyeDrop();" style="position:relative;left:40vmin;">
<br><input type="color" id="inColor" onchange="testToHex();"><br><input type="text" value="#00000000" id="hexColor" onchange="testHex();"><br>
<label for="colorSlider">Alpha: <input type="range" min="0" max="255" step="1" value="0" id="colorSlider" onchange="alphaUpdate()"></label><br><br>
<input type="button" value="Currently in replace color mode" onclick="btnChange()" id="scratch"><br><br>
<div id = "colorDiv"><div class="colorField" onclick="colorPick(0)"></div><div class="colorField" onclick="colorPick(1)"></div><div class="colorField" onclick="colorPick(2)"></div><div class="colorField" onclick="colorPick(3)"></div><div class="colorField" onclick="colorPick(4)"></div><div class="colorField" onclick="colorPick(5)"></div><div class="colorField" onclick="colorPick(6)"></div><div class="colorField" onclick="colorPick(7)"></div></div><br>
<label for="testInputFile">Import color strip: <input type = "file" id="testInputFile" onchange="testFile();"></label><input type="button" value="Save color strip" onclick="savestrip()"><br><br>
<form>
<label for="displayName">Name of robe: </label>
<input type="text" id="displayName">
<br><br><label for="description">Description of robe: </label>
<input type="text" id="description">
<br><br><label for="designer">Designer of robe: </label>
<input type="text" id="designer"><br>
<input type="button" value="Download Robe" onClick="toRobeFile()">
</form>
<img id="testImage" style="display:none;"></img><canvas style="display:none;" id="imageBuffer"></canvas>
<canvas id="eyeDrop" style="display:none;" onclick="eyeTrigger(event);"></canvas>
<script>
var eventBuffer = [];
var currentID = -1;
var eyeDropActive = false;
var eyeDropVision = document.getElementById("eyeDrop");
var eyeDropContext = eyeDropVision.getContext("2d");
function updateEyeTool(event) {
    if (eyeDropActive==false) return;
    let [x,y]=[(event.pageX-28),(event.pageY-28)];
    eyeDropVision.style.left=x+"px";
    eyeDropVision.style.top=y+"px";
    let bounds = canvas.getBoundingClientRect();
    let [cx,cy]=[x-bounds.x,y-bounds.y];
    if (cx<0 || cx+28>bounds.width || cy<0 || cy+28>bounds.height) {
        eyeDropContext.fillStyle="#000000";
        eyeDropContext.fillRect(0,0,eyeDropVision.width,eyeDropVision.height);
        return;
    }
    let imgdat1 = ctx.getImageData(cx+28,cy+28,3,3);
    let scale = 10;
    for (let y1 = 0; y1 < imgdat1.height; y1++) {
        for (let x1 = 0; x1 < imgdat1.width; x1++) {
            let color = Number.parseInt((BigInt(imgdat1.data[(y1*imgdat1.width+x1)*4])<<24n)+BigInt(imgdat1.data[(y1*imgdat1.width+x1)*4+1]<<16|imgdat1.data[(y1*imgdat1.width+x1)*4+2]<<8|imgdat1.data[(y1*imgdat1.width+x1)*4+3]));
            eyeDropContext.fillStyle=toColor(color);
            eyeDropContext.fillRect(x1*scale,y1*scale,scale,scale);
        }
    }
    eyeDropContext.fillStyle="#000000";
    eyeDropContext.fillRect(0,0,30,2);
    eyeDropContext.fillRect(0,28,30,2);
    eyeDropContext.fillRect(0,0,2,30);
    eyeDropContext.fillRect(28,0,2,30);
}
function eyeTrigger(event) {
    eyeDropActive=false;
    eyeDropVision.style.left="8000px";
    eyeDropVision.style.top="0px";
    eyeDropVision.style.display="none";
    let bounds = canvas.getBoundingClientRect();
    let [cx,cy]=[event.pageX-bounds.x-28,event.pageY-bounds.y-28];
    if (cx<0 || cx+28>bounds.width || cy<0 || cy+28>bounds.height) {
        return;
    }
    let imgdat1 = ctx.getImageData(cx+29,cy+29,1,1);
    let tmpCol = toColor(Number.parseInt((BigInt(imgdat1.data[0])<<24n)+BigInt(imgdat1.data[1]<<16|imgdat1.data[2]<<8|imgdat1.data[3])));
    color.value=tmpCol.slice(0,7);
    color2.value=tmpCol;
    document.getElementById("colorSlider").value=parseInt(tmpCol.slice(7),16);
}
function activateEyeDrop() {
    eyeDropActive=true;
    eyeDropVision.width=30;
    eyeDropVision.height=30;
    eyeDropVision.style.position="absolute";
    eyeDropVision.style.left="8000px";
    eyeDropVision.style.top="0px";
    eyeDropVision.style.display="block";
    eyeDropContext.fillStyle="#000000";
    eyeDropContext.fillRect(0,0,eyeDropVision.width,eyeDropVision.height);
}
function registerEvent(id,oldC,newC) {
    if (oldC==newC) return;
    if (eventBuffer.length>1000) {
        eventBuffer.shift();
        currentID--;
    }
    if (currentID<eventBuffer.length-1) {
        eventBuffer=eventBuffer.slice(0,Math.max(0,currentID+1));
    }
    eventBuffer.push([id,oldC,newC]);
    currentID++;
}
function undo() {
    if (currentID==-1) return;
    let lastevent = eventBuffer[currentID];
    testImageColorArray[lastevent[0]]=lastevent[1];
    currentID--;
    drawImage();
}
function redo() {
    if (currentID+1>=eventBuffer.length) return;
    currentID++;
    let lastevent = eventBuffer[currentID];
    testImageColorArray[lastevent[0]]=lastevent[2];
    drawImage();
}
var colorPickMode = false;
var colorPickZone = ["#FFFFFFFF","#FFFFFFFF","#FFFFFFFF","#FFFFFFFF","#FFFFFFFF","#FFFFFFFF","#FFFFFFFF","#FFFFFFFF"];
let colorFields = document.getElementsByClassName("colorField");
function btnChange() {
    if (document.getElementById("scratch").value=="Currently in replace color mode") {
        document.getElementById("scratch").value="Currently in pick color mode";
        resetColorSwatches("black");
        colorPickMode=true;
    } else {
        document.getElementById("scratch").value="Currently in replace color mode";
        resetColorSwatches("red");
        colorPickMode=false;
    }
}
let testImage = new Uint8Array([0, 55, 0, 35, 28, 100, 100, 100, 255, 188, 154, 106, 255, 150, 115, 65, 255, 147, 86, 16, 255, 125, 80, 28, 255, 106, 69, 27, 255, 0, 0, 0, 0, 62, 75, 36, 255, 46, 55, 26, 255, 1, 1, 1, 255, 2, 2, 2, 255, 3, 3, 3, 255, 130, 166, 50, 255, 113, 147, 36, 255, 102, 136, 20, 255, 98, 125, 23, 255, 87, 111, 22, 255, 82, 102, 26, 255, 63, 77, 23, 255, 34, 41, 13, 255, 251, 207, 0, 255, 244, 202, 0, 255, 203, 86, 60, 255, 186, 254, 254, 255, 10, 10, 10, 255, 234, 200, 152, 255, 34, 34, 34, 255, 0, 0, 0, 0, 27, 27, 27, 27, 27, 27, 27, 6, 6, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 12, 12, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 12, 12, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 12, 12, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 12, 12, 12, 12, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 12, 12, 12, 12, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 12, 12, 12, 12, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 13, 13, 12, 12, 13, 12, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 12, 13, 13, 13, 12, 12, 6, 6, 27, 27, 27, 27, 27, 27, 27, 6, 12, 13, 13, 12, 13, 12, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 13, 13, 13, 12, 13, 13, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 13, 13, 13, 13, 13, 13, 17, 17, 6, 27, 27, 27, 27, 27, 27, 27, 6, 13, 13, 13, 13, 13, 13, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 13, 13, 11, 11, 13, 13, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 13, 13, 13, 13, 13, 11, 11, 17, 6, 27, 27, 27, 27, 27, 27, 6, 6, 13, 13, 13, 13, 13, 13, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 13, 13, 11, 11, 11, 11, 13, 13, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 13, 13, 13, 13, 13, 11, 11, 11, 17, 6, 27, 27, 27, 27, 27, 27, 6, 13, 13, 13, 13, 13, 13, 13, 13, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 13, 11, 22, 11, 11, 22, 11, 13, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 17, 17, 13, 13, 11, 11, 22, 11, 17, 6, 27, 27, 27, 27, 27, 27, 6, 13, 13, 14, 14, 14, 14, 13, 13, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 17, 11, 25, 25, 25, 25, 11, 17, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 17, 18, 18, 13, 25, 25, 25, 17, 6, 27, 27, 27, 27, 27, 27, 6, 17, 14, 14, 14, 14, 16, 14, 17, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 17, 11, 25, 25, 11, 17, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 17, 18, 18, 18, 25, 17, 6, 6, 27, 27, 27, 27, 27, 27, 6, 6, 17, 17, 17, 16, 16, 17, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 12, 14, 12, 12, 12, 14, 18, 12, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 13, 13, 13, 17, 17, 18, 6, 6, 27, 27, 27, 27, 27, 27, 6, 6, 13, 17, 15, 15, 15, 15, 17, 13, 6, 6, 27, 27, 27, 27, 27, 27, 6, 6, 12, 14, 16, 14, 14, 14, 14, 21, 17, 12, 6, 6, 27, 27, 27, 27, 27, 27, 27, 6, 13, 14, 14, 13, 14, 16, 12, 6, 6, 27, 27, 27, 27, 27, 6, 6, 13, 14, 14, 15, 15, 15, 15, 14, 14, 13, 6, 6, 27, 27, 27, 27, 27, 6, 12, 17, 14, 14, 16, 16, 16, 16, 14, 14, 18, 12, 6, 27, 27, 27, 27, 27, 27, 6, 6, 14, 14, 8, 8, 8, 14, 16, 16, 6, 27, 27, 27, 27, 27, 6, 13, 13, 14, 14, 14, 15, 15, 14, 14, 14, 13, 13, 6, 27, 27, 27, 27, 27, 6, 14, 14, 8, 8, 14, 14, 14, 14, 8, 8, 14, 14, 6, 27, 27, 27, 27, 27, 27, 6, 13, 14, 8, 7, 7, 7, 8, 13, 13, 6, 27, 27, 27, 27, 27, 6, 13, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 13, 6, 27, 27, 27, 27, 27, 6, 14, 8, 7, 8, 8, 10, 10, 8, 8, 7, 8, 14, 6, 27, 27, 27, 27, 27, 27, 6, 14, 14, 7, 7, 7, 7, 7, 8, 10, 6, 27, 27, 27, 27, 27, 6, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 6, 27, 27, 27, 27, 27, 6, 14, 8, 7, 7, 7, 10, 10, 7, 7, 7, 8, 14, 6, 27, 27, 27, 27, 27, 27, 6, 14, 7, 7, 7, 8, 8, 7, 7, 10, 6, 27, 27, 27, 27, 6, 6, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 6, 6, 27, 27, 27, 6, 6, 14, 8, 8, 7, 7, 10, 10, 7, 7, 8, 8, 14, 6, 6, 27, 27, 27, 27, 6, 6, 14, 7, 7, 7, 8, 7, 7, 7, 10, 6, 27, 27, 27, 27, 6, 13, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 13, 6, 27, 27, 27, 6, 14, 14, 2, 8, 7, 7, 10, 10, 7, 7, 8, 2, 14, 14, 6, 27, 27, 27, 27, 6, 13, 14, 19, 2, 7, 8, 7, 7, 7, 10, 6, 27, 27, 27, 27, 6, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 6, 27, 27, 27, 6, 14, 14, 1, 19, 8, 7, 10, 10, 7, 8, 19, 1, 14, 14, 6, 27, 27, 27, 27, 6, 14, 14, 19, 1, 19, 7, 7, 7, 7, 10, 6, 27, 27, 27, 27, 6, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 6, 27, 27, 6, 6, 14, 14, 0, 19, 3, 3, 20, 20, 3, 3, 19, 0, 14, 14, 6, 6, 27, 27, 6, 6, 14, 14, 19, 0, 19, 3, 3, 3, 3, 20, 6, 27, 27, 27, 6, 6, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 14, 6, 6, 27, 6, 14, 14, 14, 1, 19, 8, 8, 9, 9, 8, 8, 19, 1, 14, 14, 14, 6, 27, 27, 6, 14, 14, 14, 19, 2, 19, 8, 8, 8, 8, 9, 6, 27, 27, 27, 6, 13, 14, 14, 16, 14, 14, 14, 14, 14, 14, 14, 16, 14, 14, 14, 13, 6, 27, 6, 14, 14, 14, 19, 19, 8, 7, 9, 9, 7, 8, 19, 19, 14, 14, 14, 6, 27, 27, 6, 14, 14, 14, 19, 19, 19, 7, 7, 7, 7, 9, 6, 27, 27, 27, 6, 14, 14, 14, 16, 14, 14, 14, 14, 14, 14, 14, 16, 14, 13, 14, 14, 6, 27, 6, 14, 14, 19, 19, 8, 7, 9, 9, 9, 9, 7, 8, 19, 19, 14, 14, 6, 27, 27, 6, 14, 14, 14, 19, 19, 7, 7, 7, 7, 9, 9, 6, 27, 27, 27, 6, 14, 14, 14, 16, 14, 14, 14, 13, 14, 14, 14, 16, 14, 13, 14, 14, 6, 27, 6, 6, 14, 19, 19, 7, 9, 9, 9, 9, 9, 9, 7, 19, 19, 14, 6, 6, 27, 27, 6, 6, 14, 14, 19, 19, 7, 7, 9, 9, 9, 9, 6, 27, 27, 27, 6, 6, 14, 16, 16, 14, 14, 14, 13, 14, 14, 14, 16, 16, 13, 14, 6, 6, 27, 27, 6, 14, 19, 19, 9, 9, 9, 19, 19, 9, 9, 9, 19, 19, 14, 6, 27, 27, 27, 27, 6, 6, 14, 19, 19, 19, 9, 9, 9, 9, 9, 6, 27, 27, 27, 27, 6, 6, 6, 16, 16, 14, 14, 13, 13, 14, 14, 16, 16, 6, 6, 6, 27, 27, 27, 6, 14, 6, 19, 9, 9, 9, 19, 19, 9, 9, 9, 19, 6, 14, 6, 27, 27, 27, 27, 27, 6, 6, 14, 19, 19, 9, 9, 9, 9, 9, 6, 27, 27, 27, 27, 27, 27, 6, 6, 16, 14, 14, 13, 13, 14, 14, 16, 6, 6, 27, 27, 27, 27, 27, 6, 6, 6, 6, 9, 9, 9, 19, 19, 9, 9, 9, 6, 6, 6, 6, 27, 27, 27, 27, 27, 27, 6, 6, 6, 19, 9, 9, 9, 9, 9, 6, 27, 27, 27, 27, 27, 27, 27, 6, 6, 9, 9, 14, 13, 9, 9, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 9, 9, 6, 6, 9, 9, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 9, 9, 9, 9, 9, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 6, 9, 9, 6, 6, 9, 9, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 3, 6, 6, 6, 6, 3, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 9, 9, 9, 6, 3, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 3, 6, 6, 6, 6, 3, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 5, 6, 27, 27, 6, 5, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 3, 6, 6, 5, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 5, 6, 27, 27, 6, 5, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 5, 6, 27, 27, 6, 5, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 5, 6, 6, 5, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 5, 6, 27, 27, 6, 5, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 5, 6, 27, 27, 6, 5, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 5, 6, 6, 5, 6, 6, 27, 27, 27, 27, 27, 27, 27, 6, 6, 5, 6, 27, 27, 6, 5, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 4, 5, 6, 27, 27, 6, 5, 4, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 5, 6, 6, 5, 4, 6, 27, 27, 27, 27, 27, 27, 27, 6, 4, 5, 6, 27, 27, 6, 5, 4, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 6, 6, 27, 27, 6, 6, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 5, 4, 6, 6, 6, 6, 27, 27, 27, 27, 27, 27, 27, 6, 6, 6, 6, 27, 27, 6, 6, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 6, 6, 6, 6, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27]);
let color = document.getElementById("inColor");
let color2 = document.getElementById("hexColor");
let lastColor = null;
function resetColorSwatches(color) {
    if (color==null) {
        if (lastColor==null) return;
        color=lastColor;
    }
    lastColor=color;
    let str = "4px solid "+color;
    for (let i = 0; i < colorFields.length; i++) {
        colorFields[i].style.outline=str;
    }
}
function colorPick(id) {
    let curColor = "";
    if (colorPickMode) {
        resetColorSwatches("black");
        curColor = colorPickZone[id];
        color.value=curColor.slice(0,7);
        color2.value=curColor;
        document.getElementById("colorSlider").value=parseInt(curColor.slice(7),16);
        colorFields[id].style.outline="4px solid #A0FFA0";
        return;
    }
    curColor=color2.value;
    colorPickZone[id]=curColor;
    colorFields[id].style.backgroundColor=curColor;
}
function alphaUpdate() {
    resetColorSwatches();
    let val = parseInt(document.getElementById("colorSlider").value).toString(16).toUpperCase();
    while (val.length<2) val="0"+val;
    color2.value=color2.value.slice(0,7)+val;
}
let canvas = document.getElementById("test");
let ctx = canvas.getContext("2d",{"willReadFrequently":true});
let testImageColorArray = [];
let testImageIndexArray = [];
let skipArray = [];
let skipIndex = [];
let skipCount = 0;
let imageHeight = 0;
let imageWidth = 0;
let offsetX = 1;
let offsetY = 1;
let iOffsetX = 0;
let iOffsetY = 0;
let pixelScaleX = 16;
let pixelScaleY = 16;
let viewPortX = 56;
let viewPortY = 36;
let someValue = 16;
//full red = 28;
window.onresize = function(){
    if (window.innerHeight<64) return;
    someValue=Math.max(1,Math.ceil(window.innerHeight*0.019));
    checkScale();
    canvas.height=pixelScaleY*viewPortY;
    canvas.width=pixelScaleX*(viewPortX-skipCount);
    drawImage();
}
function checkScale() {
    for (let i = 0; i < someValue && pixelScaleX*(viewPortX-skipCount)<window.innerWidth; i++) {
        pixelScaleX++;
        if (pixelScaleX>=someValue) break;
    }
    for (let i = 0; i < someValue && pixelScaleY*(viewPortY-skipCount)<window.innerHeight; i++) {
        pixelScaleY++;
        if (pixelScaleY>=someValue) break;
    }
    for (let i = 0; i < someValue && pixelScaleX>1 && pixelScaleX*(viewPortX-skipCount)>window.innerWidth; i++) {
        pixelScaleX--;
    }
    for (let i = 0; i < someValue && pixelScaleY>1 && pixelScaleY*viewPortY>window.innerHeight; i++) {
        pixelScaleY--;
    }
    pixelScaleX=Math.min(pixelScaleX,pixelScaleY);
    if (pixelScaleX>1) pixelScaleX=pixelScaleX&0xFE;
    pixelScaleY=pixelScaleX;
}
window.onload = function(){
    someValue=Math.max(1,Math.ceil(window.innerHeight*0.019));
    checkScale();
    canvas.height=pixelScaleY*viewPortY;
    canvas.width=pixelScaleX*(viewPortX-skipCount);
    let tmpCount = 0;
    imageWidth = testImage[tmpCount++]<<8|testImage[tmpCount++];
    imageHeight = testImage[tmpCount++]<<8|testImage[tmpCount++];
    let loop = testImage[tmpCount++];
    testImageColorArray=[];
    testImageIndexArray=[];
    for (let i = 0; i < loop; i++) {
        testImageColorArray[testImageColorArray.length]=Number.parseInt(BigInt(testImage[tmpCount++])<<24n|BigInt(testImage[tmpCount++]<<16|testImage[tmpCount++]<<8|testImage[tmpCount++]));
    }
    for (let i = 0; i < imageHeight*imageWidth; i++) {
        testImageIndexArray[testImageIndexArray.length]=testImage[tmpCount++];
    }
    testImageIndexArray=new Uint8Array(testImageIndexArray);
    /*
    let tmpList15 = [];
    let tmpList16 = [];
    for (let i = 0; i < testImageColorArray.length; i++) {
        tmpList15[i]=testImageColorArray[i]>>24&0xFF;
    }
    tmpList15.sort();
    for (let i = 0; i < testImageColorArray.length; i++) {
        tmpList16[tmpList15.indexOf(testImageColorArray[i]>>24&0xFF)] = testImageColorArray[i];
    }
    for (let i = 0; i < testImageIndexArray.length; i++) {
        testImageIndexArray[i] = tmpList16.indexOf(testImageColorArray[testImageIndexArray[i]]);
    }
    //testImageColorArray=tmpList16;
    */
    //testImageColorArray = [1684301055, 3164236543, 2524135935, 2471891199, 2102402303, 1782914047, 0, 1045112063, 775363327, 16843263, 33686271, 50529279, 2191930111, 1905468671, 1720194303, 1652365311, 1466898175, 1382423295, 1062017023, 573115903, 4224647423, 4106879231, 3411426559, 3137273599, 168430335, 3939014911, 572662527, 0];
    


    //testImageColorArray=[2088796159,3685785599,2121096703,2121096703,1633045503,1633045503,4292214815,1347839743,1044467711,255,255,255,4294967295,3554137855,2795939583,2290649343,4261412863,2189853951,1465341951,606481663,4292635903,4292635647,4261412863,255,255,255,255,255];
    //testImageColorArray=[855835647, 255, 255, 855835647, 255, 421075455, 13619008, 1717987071, 858993663, 255, 255, 255, 421075455, 421075455, 255, 255, 255, 421075455, 255, 421075455, 4291559679, 4288217343, 13421823, 3137273599, 168430335, 255, 572662527, 0x00E3E309];
    /*
    let otherArrayTest = [];
    let otherOffset = 0;
    for (let i = 0; i < testImageColorArray.length; i++) {
        otherArrayTest[i]=testImageColorArray[(otherOffset+i)%testImageColorArray.length];
    }
    testImageColorArray=otherArrayTest;
    */
    drawImage();
};
function createNewArray() {
    let newArr = [];
    skipCount=0;
    for (let i = 0; i < skipIndex.length; i++) {
        skipCount+=skipIndex[i];
    }
    let scratchPad = imageWidth-skipCount;
    newArr.push(scratchPad>>8);
    newArr.push(scratchPad&0xFF);
    newArr.push(imageHeight>>8);
    newArr.push(imageHeight&0xFF);
    newArr.push(testImageColorArray.length);
    for (let i = 0; i < testImageColorArray.length; i++) {
        for (let l = 0; l < 4; l++) {
            newArr.push((testImageColorArray[i]>>((3-l)*8))&0xFF);
        }
    }
    for (let y = 0; y < imageHeight; y++) {
        for (let x = 0; x < imageWidth; x++) {
            if (skipArray.includes(x)) {
                x+=skipIndex[skipArray.indexOf(x)];
            }
            newArr.push(testImageIndexArray[imageWidth*y+x]);
        }
    }
    testImage=new Uint8Array(newArr);
    skipArray=[];
    skipIndex=[];
    window.onload();
    let outStr = "[";
    for (let i = 0; i < newArr.length; i++) {
        outStr+=newArr[i];
        if (i+1<newArr.length) {
            outStr+=", ";
        }
    }
    outStr+="]";
    console.log(outStr);
}
function testFile() {
    let tmp = document.getElementById("testInputFile");
    if (tmp==null) return;
    if (tmp.files.length==0) return;
    let img = document.getElementById("testImage");
    let bufferCanvas = document.getElementById("imageBuffer");
    img.onload = function(){
        if (img.width!=56 || img.height!=2) return;
        bufferCanvas.width = img.width;
        bufferCanvas.height = img.height;
        //imageHeight=img.height;
        //imageWidth=img.width;
        let ctx1 = bufferCanvas.getContext("2d");
        ctx1.drawImage(img,0,0);
        URL.revokeObjectURL(img.src);
        for (let i = 0; i < 255; i++) {
            i--;
            i++;
        }
        let imageData = ctx1.getImageData(0,0,img.width,img.height);
        for (let i = 0; i < 56; i++) {
            let cur = Number.parseInt(BigInt(imageData.data[i*4])<<24n | BigInt((imageData.data[i*4+1]<<16)|(imageData.data[i*4+2]<<8)|(imageData.data[i*4+3])));
            testImageColorArray[i>>1]=cur;
            i++;
        }
        /*
        let outText = "";//"new Uint8Array([";
        let testArray = [];
        let xcount = 0;
        for (let i = 0; i < (imageData.data.length>>3); i+=2) {
            //if (xcount++>28) continue;
            testArray[testArray.length]=Number.parseInt(BigInt(imageData.data[i*4])<<24n | BigInt((imageData.data[i*4+1]<<16)|(imageData.data[i*4+2]<<8)|(imageData.data[i*4+3])));
        }
        /*
        for (let i = 0; i < testArray.length; i++) {
            outText+="\""+toColor(testArray[i])+"\", ";
        }
        */
        //testArray[testArray.length-1]=0;
        //testImageColorArray=testArray;
        drawImage();
        /*
        let colorArray = [];
        let imageArray = [];
        for (let i = 0; i < imageData.data.length; i++) {
            let red = imageData.data[i];
            let color = Number.parseInt(BigInt(imageData.data[i++])<<24n | BigInt(imageData.data[i++]<<16|imageData.data[i++]<<8|imageData.data[i]));
            colorArray[red]=color;
        }
        let tmpList = [];
        for (let i = 0; i < colorArray.length; i++) {
            if (colorArray[i]==null) continue;
            tmpList[tmpList.length]=colorArray[i];
        }
        colorArray=tmpList;
        console.log(colorArray);
        for (let i = 0; i < imageData.data.length; i++) {
            let color = Number.parseInt(BigInt(imageData.data[i++])<<24n | BigInt(imageData.data[i++]<<16|imageData.data[i++]<<8|imageData.data[i]));
            imageArray[imageArray.length]=colorArray.indexOf(color);
        }
        //testImageColorArray = colorArray;
        //testImageIndexArray = imageArray;
        //drawImage();

        let newArrayTest = [];
        newArrayTest[newArrayTest.length]=bufferCanvas.width>>8&0xFF;
        newArrayTest[newArrayTest.length]=bufferCanvas.width&0xff;
        newArrayTest[newArrayTest.length]=bufferCanvas.height>>8&0xFF;
        newArrayTest[newArrayTest.length]=bufferCanvas.height&0xff;
        newArrayTest[newArrayTest.length]=colorArray.length&0xFF;
        for (let i = 0; i < colorArray.length; i++) {
            newArrayTest[newArrayTest.length]=colorArray[i]>>24&0xFF;
            newArrayTest[newArrayTest.length]=colorArray[i]>>16&0xFF;
            newArrayTest[newArrayTest.length]=colorArray[i]>>8&0xFF;
            newArrayTest[newArrayTest.length]=colorArray[i]&0xFF;
        }
        for (let i = 0; i < imageArray.length; i++) {
            newArrayTest[newArrayTest.length]=imageArray[i];
        }
        for (let i = 0; i < newArrayTest.length; i++) {
            outText+=newArrayTest[i]+", ";
        }
        outText=outText.slice(0,outText.length-2)+"]);";
        //console.log(outText);
        */
    };
    img.src=URL.createObjectURL(tmp.files[tmp.files.length-1]);
}
function testToHex() {
    resetColorSwatches();
    color2.value=color.value.toUpperCase()+"FF";
    document.getElementById("colorSlider").value="255";
}
function testHex() {
    resetColorSwatches();
    let stringIn = color2.value.toUpperCase();
    let stringOut = "";
    for (let i = 0; i < stringIn.length; i++) {
        switch (stringIn.charAt(i)) {
            case "A":
            case "B":
            case "C":
            case "D":
            case "E":
            case "F":
            case "0":
            case "1":
            case "2":
            case "3":
            case "4":
            case "5":
            case "6":
            case "7":
            case "8":
            case "9":
                stringOut+=stringIn.charAt(i);
            default:
                break;
        }
    }
    while (stringOut.length<6) stringOut="0"+stringout;
    if (stringOut.length==6 || stringOut.length==8) {
        if (stringOut.length==6) stringOut+="FF";
        color2.value="#"+stringOut;
        color.value=("#"+stringOut).slice(0,7);
    }
    document.getElementById("colorSlider").value=parseInt(stringOut.slice(6),16);
}
function testFunction(e) {
    if (e==null) return;
    let [x,y] = [Math.floor(e.offsetX/pixelScaleX),Math.floor(e.offsetY/pixelScaleY)];
    x+=iOffsetX;
    y+=iOffsetY;
    x-=offsetX;
    y-=offsetY;
    if (x<0) x=0;
    if (y<0) y=0;
    let save = 0;
    for (let i = 0; i < skipArray.length; i++) {
        if (skipArray[i]<=x) {
            save=skipIndex[i];
        }
    }
    x+=save;
    let index = testImageIndexArray[y*imageWidth+x];
    save = testImageColorArray[index];
    if (color2.value.substring(1).length==6) {
        testImageColorArray[index]=Number.parseInt(BigInt(parseInt(color.value.substring(1),16))<<8n);
    }
    if (color2.value.substring(1).length==8) {
        testImageColorArray[index]=Number.parseInt(color2.value.substring(1),16);    
    }
    registerEvent(index,save,testImageColorArray[index]);
    drawImage();
}
function toColor(id) {
        let [r,g,b,a] = [(id>>24)&0xFF,(id>>16)&0xFF,(id>>8)&0xFF,id&0xFF];
        [r,g,b,a] = [r.toString(16).toUpperCase(),g.toString(16).toUpperCase(),b.toString(16).toUpperCase(),a.toString(16).toUpperCase()];
        r = r.length==2?r:"0"+r;
        g = g.length==2?g:"0"+g;
        b = b.length==2?b:"0"+b;
        a = a.length==2?a:"0"+a;
        return "#"+r+g+b+a;
    }
function drawImage(something=0) {
    ctx.fillStyle="#000000FF";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    for (let x = 0; x < Math.ceil(canvas.width/(pixelScaleX>>1)); x++) {
        for (let y = 0; y < Math.ceil(canvas.height/(pixelScaleY>>1)); y++) {
            if ((x+y)&1) {
                ctx.fillStyle="#505050FF";
            } else {
                ctx.fillStyle="#404040FF";
            }
            ctx.fillRect(x*(pixelScaleX>>1),y*(pixelScaleY>>1),pixelScaleX>>1,pixelScaleY>>1);
        }
    }
    let negX = 0;
    for (let x = 0; x <= viewPortX; x++) {
        if (skipArray.indexOf(x)!=-1) {
            negX+=skipIndex[skipArray.indexOf(x)];
        }
        for (let y = 0; y <= viewPortY; y++) {
            let colX = x+negX;
            let colY = y;
            if (colX<offsetX) {
                colX=0;
                colY=0;
            } else {
                colX-=offsetX;
            }
            if (colY<offsetY) {
                colX=0;
                colY=0;
            } else {
                colY-=offsetY;
            }
            if (colY>=imageHeight || colX>=imageWidth) {
                colX=0;
                colY=0;
            }
            /*
            if (testImageIndexArray[(iOffsetY+colY)*imageWidth+(iOffsetX+colX)]>=27) {
                ctx.fillStyle="#00000000";
            } else {*/
                ctx.fillStyle=toColor(testImageColorArray[testImageIndexArray[(iOffsetY+colY)*imageWidth+(iOffsetX+colX)]]);
            //}
            ctx.fillRect(x*pixelScaleX,y*pixelScaleY,pixelScaleX,pixelScaleY);
        }
    }
}
function updateBufferCanvas() {
    let bufferCanvas = document.getElementById("imageBuffer");
    let context = bufferCanvas.getContext("2d");
    bufferCanvas.width=56;
    bufferCanvas.height=2;
    for (let i = 0; i < 28; i++) {
        context.fillStyle=toColor(testImageColorArray[i]);
        context.fillRect(i*2,0,2,2);
    }
}
function toRobeFile() {
    updateBufferCanvas();
    let bufferCanvas = document.getElementById("imageBuffer");
    let text = bufferCanvas.toDataURL();
    let seperator = "***BREAK***";
    text=text.slice(text.indexOf("base64,")+7);
    text=document.getElementById("displayName").value+seperator+document.getElementById("description").value+seperator+document.getElementById("designer").value+seperator+text;
    let blob = new Blob([text]);
    let a = document.createElement("a");
    a.download=document.getElementById("displayName").value+".robe";
    a.href=URL.createObjectURL(blob);
    a.click();
    URL.revokeObjectURL(a.href);
}
function savestrip() {
    updateBufferCanvas();
    let bufferCanvas = document.getElementById("imageBuffer");
    bufferCanvas.toBlob((blob)=>{
        let a = document.createElement("a");
        a.download="Strip.png";
        a.href=URL.createObjectURL(blob);
        a.click();
        URL.revokeObjectURL(a.href);
    });
}
</script>
</body>
</html>
